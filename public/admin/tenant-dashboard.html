<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - NARUKAMI</title>
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <div id="admin-nav-root"></div>

    <div class="admin-page">
        <div class="admin-container-wide">

            <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="admin-page-header" style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:12px;">
                <div>
                    <h1 class="admin-page-title" id="tenantName">èª­ã¿è¾¼ã¿ä¸­...</h1>
                    <p class="admin-page-subtitle" id="tenantDomain"></p>
                </div>
                <span class="badge badge-primary" id="tenantPlan" style="font-size:13px; padding:5px 14px;"></span>
            </div>

            <!-- KPIã‚«ãƒ¼ãƒ‰ -->
            <div class="kpi-cards">
                <div class="kpi-card kpi-card--users">
                    <div class="kpi-icon-wrap">ğŸ‘¤</div>
                    <div class="kpi-body">
                        <div class="kpi-label">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</div>
                        <div class="kpi-value" id="kpiTotalUsers">-</div>
                        <div class="kpi-trend" id="kpiUsersChange"></div>
                    </div>
                </div>
                <div class="kpi-card kpi-card--new">
                    <div class="kpi-icon-wrap">âœ¨</div>
                    <div class="kpi-body">
                        <div class="kpi-label">ä»Šé€±ã®æ–°è¦ç™»éŒ²</div>
                        <div class="kpi-value" id="kpiNewUsers">-</div>
                        <div class="kpi-trend" id="kpiNewUsersChange"></div>
                    </div>
                </div>
                <div class="kpi-card kpi-card--open">
                    <div class="kpi-icon-wrap">âœ‰ï¸</div>
                    <div class="kpi-body">
                        <div class="kpi-label">å¹³å‡é–‹å°ç‡</div>
                        <div class="kpi-value" id="kpiOpenRate">-</div>
                        <div class="kpi-trend" id="kpiOpenRateChange"></div>
                    </div>
                </div>
                <div class="kpi-card kpi-card--ctr">
                    <div class="kpi-icon-wrap">ğŸ–±</div>
                    <div class="kpi-body">
                        <div class="kpi-label">å¹³å‡CTR</div>
                        <div class="kpi-value" id="kpiCtr">-</div>
                        <div class="kpi-trend" id="kpiCtrChange"></div>
                    </div>
                </div>
                <div class="kpi-card kpi-card--sent">
                    <div class="kpi-icon-wrap">ğŸ“Š</div>
                    <div class="kpi-body">
                        <div class="kpi-label">ä»Šæœˆã®é€ä¿¡æ•°</div>
                        <div class="kpi-value" id="kpiMonthlySent">-</div>
                        <div class="kpi-trend" id="kpiMonthlySentChange"></div>
                    </div>
                </div>
                <div class="kpi-card kpi-card--tasks">
                    <div class="kpi-icon-wrap">ğŸ“‹</div>
                    <div class="kpi-body">
                        <div class="kpi-label">æœªå¯¾å¿œã‚¿ã‚¹ã‚¯</div>
                        <div class="kpi-value" id="kpiPendingTasks">-</div>
                        <div class="kpi-trend"></div>
                    </div>
                </div>
            </div>

            <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <span class="card-title">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</span>
                </div>
                <div class="card-body" style="display:flex; gap:12px; flex-wrap:wrap;">
                    <a href="/admin/create" class="btn btn-primary">ï¼‹ é€šçŸ¥ä½œæˆ</a>
                    <a href="/admin/sequences" class="btn btn-secondary">ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡</a>
                    <a href="/admin/users" class="btn btn-secondary">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
                    <a href="/admin/managed" class="btn btn-secondary">ãƒ†ãƒŠãƒ³ãƒˆç®¡ç†</a>
                </div>
            </div>

            <!-- æœ€è¿‘ã®é€šçŸ¥ -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-header">
                    <span class="card-title">æœ€è¿‘ã®é€šçŸ¥</span>
                    <a href="/admin/create" class="btn btn-primary btn-sm">æ–°è¦ä½œæˆ</a>
                </div>
                <div class="card-body" style="padding:0;">
                    <div class="table-wrap" id="recentNotifications">
                        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
            <div class="charts-section">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨ç§»</span>
                        <div class="chart-period">
                            <button class="period-btn" onclick="setPeriod('7d', this)">7æ—¥</button>
                            <button class="period-btn active" onclick="setPeriod('30d', this)">30æ—¥</button>
                            <button class="period-btn" onclick="setPeriod('90d', this)">90æ—¥</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="usersChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">é€šçŸ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆç›´è¿‘10ä»¶ï¼‰</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="notificationsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="/admin/admin.js"></script>
    <script>
        let tenantId = null;
        let currentTenant = null;
        let usersChart = null;
        let notificationsChart = null;

        async function onAdminReady(user) {
            await loadTenantInfo();
            await Promise.all([
                loadKPIs(),
                loadRecentNotifications(),
                loadChart('30d')
            ]);
        }

        function getCurrentDomain() { return window.location.hostname; }

        async function loadTenantInfo() {
            try {
                const res = await apiGet(`/api/stats?domain=${encodeURIComponent(getCurrentDomain())}`);
                if (res && res.ok) {
                    const result = await res.json();
                    if (result.status === 'ok' && result.data.tenant) {
                        currentTenant = result.data.tenant;
                        tenantId = currentTenant.id;
                        document.getElementById('tenantName').textContent = currentTenant.name;
                        document.getElementById('tenantDomain').textContent = currentTenant.domain || getCurrentDomain();
                        document.getElementById('tenantPlan').textContent = (currentTenant.plan || 'basic').toUpperCase();
                        return;
                    }
                }
            } catch (err) {
                console.error('Failed to load tenant info:', err);
            }
            showMockData();
        }

        function showMockData() {
            const domain = getCurrentDomain();
            currentTenant = { id: 1, name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­', domain, plan: 'pro', monthly_sent_count: 0, monthly_limit: 100000 };
            tenantId = currentTenant.id;
            document.getElementById('tenantName').textContent = currentTenant.name;
            document.getElementById('tenantDomain').textContent = domain;
            document.getElementById('tenantPlan').textContent = 'PRO';
        }

        async function loadKPIs() {
            if (!tenantId) return;
            try {
                const res = await apiGet(`/api/analytics?type=overview&tenant_id=${tenantId}`);
                if (res && res.ok) {
                    const result = await res.json();
                    const data = result.data || {};

                    setKpi('kpiTotalUsers', formatNumber(data.total_users || 0), 'kpiUsersChange', data.trends?.users_change_pct);
                    setKpi('kpiNewUsers', formatNumber(data.new_users_this_week || 0), 'kpiNewUsersChange', data.trends?.new_users_change_pct);
                    setKpi('kpiOpenRate', formatPercent(data.avg_open_rate || 0), 'kpiOpenRateChange', data.trends?.open_rate_change_pct);
                    setKpi('kpiCtr', formatPercent(data.avg_ctr || 0), 'kpiCtrChange', data.trends?.ctr_change_pct);

                    if (currentTenant) {
                        document.getElementById('kpiMonthlySent').textContent = formatNumber(currentTenant.monthly_sent_count || 0);
                        document.getElementById('kpiMonthlySentChange').textContent = `ä¸Šé™: ${formatNumber(currentTenant.monthly_limit || 0)}`;
                    }
                    if (currentTenant?.stats) {
                        document.getElementById('kpiPendingTasks').textContent = formatNumber(currentTenant.stats.pending_task_count || 0);
                    } else {
                        document.getElementById('kpiPendingTasks').textContent = '0';
                    }
                } else {
                    showMockKPIs();
                }
            } catch (err) {
                console.error('Failed to load KPIs:', err);
                showMockKPIs();
            }
        }

        function setKpi(valueId, value, trendId, changePct) {
            document.getElementById(valueId).textContent = value;
            if (trendId && changePct !== undefined && changePct !== null) {
                const el = document.getElementById(trendId);
                const positive = changePct >= 0;
                el.textContent = `å‰é€±æ¯” ${positive ? '+' : ''}${Number(changePct).toFixed(1)}%`;
                el.className = `kpi-trend ${positive ? 'positive' : 'negative'}`;
            }
        }

        function showMockKPIs() {
            ['kpiTotalUsers','kpiNewUsers'].forEach(id => document.getElementById(id).textContent = '0');
            ['kpiOpenRate','kpiCtr'].forEach(id => document.getElementById(id).textContent = '0%');
            ['kpiMonthlySent','kpiPendingTasks'].forEach(id => document.getElementById(id).textContent = '0');
        }

        async function loadRecentNotifications() {
            if (!tenantId) return;
            const container = document.getElementById('recentNotifications');
            try {
                // analyticsAPIã¯é€ä¿¡æ¸ˆã¿ã®ã¿ã‚’send_at DESCã§è¿”ã™ + ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä»˜ã
                const res = await apiGet(`/api/analytics?type=notifications&limit=10&tenant_id=${tenantId}`);
                if (!res || !res.ok) {
                    container.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
                    return;
                }
                const result = await res.json();
                const notifications = result.data || [];

                if (notifications.length === 0) {
                    container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--color-text-muted);">é€ä¿¡æ¸ˆã¿ã®é€šçŸ¥ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                container.innerHTML = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                                <th>é€ä¿¡æ—¥æ™‚</th>
                                <th>é€ä¿¡æ•°</th>
                                <th>é–‹å°ç‡</th>
                                <th>CTR</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${notifications.map(notif => {
                                const sendDate = notif.send_at
                                    ? new Date(notif.send_at).toLocaleString('ja-JP', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' })
                                    : '-';
                                return `<tr>
                                    <td style="font-weight:500; max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(notif.title || '')}</td>
                                    <td style="white-space:nowrap; color:var(--color-text-muted);">${sendDate}</td>
                                    <td>${formatNumber(notif.performance?.total_sent || 0)}</td>
                                    <td>${formatPercent(notif.performance?.open_rate || 0)}</td>
                                    <td>${formatPercent(notif.performance?.ctr || 0)}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>`;
            } catch (err) {
                console.error('Failed to load notifications:', err);
                container.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
            }
        }

        function setPeriod(period, btn) {
            document.querySelectorAll('.chart-period .period-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadChart(period);
        }

        async function loadChart(period) {
            if (!tenantId) return;
            try {
                const [trendsRes, notifRes] = await Promise.all([
                    apiGet(`/api/analytics?type=trends&metric=users&period=${period}&tenant_id=${tenantId}`),
                    apiGet(`/api/analytics?type=notifications&limit=10&tenant_id=${tenantId}`)
                ]);

                if (trendsRes && trendsRes.ok) {
                    const trendsResult = await trendsRes.json();
                    const dataPoints = trendsResult.data?.data_points || [];
                    const ctx1 = document.getElementById('usersChart');
                    if (ctx1) {
                        if (usersChart) usersChart.destroy();
                        usersChart = new Chart(ctx1.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: dataPoints.map(d => { const dt = new Date(d.date); return `${dt.getMonth()+1}/${dt.getDate()}`; }),
                                datasets: [
                                    { label: 'ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°', data: dataPoints.map(d => d.value || 0), borderColor: '#6366F1', backgroundColor: 'rgba(99,102,241,0.08)', tension: 0.4, fill: true },
                                    { label: 'æ–°è¦ç™»éŒ²', data: dataPoints.map(d => d.new || 0), borderColor: '#10B981', backgroundColor: 'rgba(16,185,129,0.08)', tension: 0.4, fill: true }
                                ]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: { legend: { position: 'top' } },
                                scales: { y: { beginAtZero: true, grid: { color: '#F1F5F9' } }, x: { grid: { color: '#F1F5F9' } } }
                            }
                        });
                    }
                }

                if (notifRes && notifRes.ok) {
                    const notifResult = await notifRes.json();
                    const notifications = (notifResult.data || []).slice(0, 10).reverse();
                    const ctx2 = document.getElementById('notificationsChart');
                    if (ctx2 && notifications.length > 0) {
                        if (notificationsChart) notificationsChart.destroy();
                        notificationsChart = new Chart(ctx2.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: notifications.map((n, i) => `é€šçŸ¥${i + 1}`),
                                datasets: [
                                    { label: 'é–‹å°ç‡ (%)', data: notifications.map(n => n.performance?.open_rate || 0), backgroundColor: 'rgba(99,102,241,0.8)', borderRadius: 4 },
                                    { label: 'CTR (%)', data: notifications.map(n => n.performance?.ctr || 0), backgroundColor: 'rgba(6,182,212,0.8)', borderRadius: 4 }
                                ]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: { legend: { position: 'top' } },
                                scales: { y: { beginAtZero: true, grid: { color: '#F1F5F9' } }, x: { grid: { display: false } } }
                            }
                        });
                    }
                }
            } catch (err) {
                console.error('Failed to load charts:', err);
            }
        }
    </script>
</body>
</html>
