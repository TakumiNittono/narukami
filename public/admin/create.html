<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通知作成 - Narukami 管理画面</title>
    <link rel="stylesheet" href="/admin/admin.css">
</head>
<body>
    <div id="admin-nav-root"></div>

    <div id="createScreen" class="admin-page">
        <div class="container">

        <div class="container">
            <form id="createForm" class="create-form">
                <div class="form-group">
                    <label for="title">タイトル <span class="required">*</span></label>
                    <input type="text" id="title" name="title" required maxlength="100" class="form-input">
                    <span class="form-hint">最大100文字</span>
                </div>

                <div class="form-group">
                    <label for="body">本文 <span class="required">*</span></label>
                    <textarea id="body" name="body" required maxlength="500" rows="5" class="form-textarea"></textarea>
                    <span class="form-hint">2〜3行推奨、最大500文字</span>
                </div>

                <div class="form-group">
                    <label for="url">タップ時のURL（省略可）</label>
                    <input type="url" id="url" name="url" class="form-input" placeholder="https://example.com">
                </div>

                <div class="form-group">
                    <label>送信対象</label>
                    <div class="target-selector">
                        <label class="radio-label">
                            <input type="radio" name="target_type" value="all" checked onchange="updateTargetType()">
                            全ユーザー
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="target_type" value="segment" onchange="updateTargetType()">
                            セグメント指定
                        </label>
                    </div>
                    
                    <div id="segmentSelector" style="display: none; margin-top: 15px;">
                        <select id="segmentSelect" class="form-input" onchange="updateTargetCount()">
                            <option value="">セグメントを選択...</option>
                        </select>
                        <div id="targetCount" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="send_at">送信日時 <span class="required">*</span></label>
                    <input type="datetime-local" id="send_at" name="send_at" required class="form-input">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">予約作成</button>
                    <a href="/admin" class="btn-secondary">キャンセル</a>
                </div>

                <div id="formError" class="error-message" style="display: none;"></div>
                <div id="formSuccess" class="success-message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="/admin/admin.js"></script>
    <script>
        var segments = [];
        var pageTenantId = null;

        async function onAdminReady(user) {
            await loadTenantId();
            await loadSegments();

            var createForm = document.getElementById('createForm');
            if (createForm) createForm.addEventListener('submit', handleFormSubmit);
        }

        function showFormError(message) {
            var errorDiv = document.getElementById('formError');
            if (errorDiv) { errorDiv.textContent = message; errorDiv.style.display = 'block'; }
            var successDiv = document.getElementById('formSuccess');
            if (successDiv) successDiv.style.display = 'none';
        }

        function showFormSuccess(message) {
            var successDiv = document.getElementById('formSuccess');
            if (successDiv) { successDiv.textContent = message; successDiv.style.display = 'block'; }
            var errorDiv = document.getElementById('formError');
            if (errorDiv) errorDiv.style.display = 'none';
        }

        async function loadTenantId() {
            try {
                var res = await apiGet('/api/stats?domain=' + encodeURIComponent(window.location.hostname));
                if (res && res.ok) {
                    var result = await res.json();
                    if (result.status === 'ok' && result.data && result.data.tenant) {
                        pageTenantId = result.data.tenant.id;
                    }
                }
            } catch (err) {
                console.error('Failed to load tenant ID:', err);
            }
        }

        async function loadSegments() {
            try {
                var url = pageTenantId
                    ? '/api/segments?action=list&tenant_id=' + pageTenantId
                    : '/api/segments?action=list';
                var response = await apiGet(url);
                if (response && response.ok) {
                    var result = await response.json();
                    segments = result.data || [];
                    var select = document.getElementById('segmentSelect');
                    if (select) {
                        select.innerHTML = '<option value="">セグメントを選択...</option>';
                        segments.forEach(function(seg) {
                            var option = document.createElement('option');
                            option.value = seg.id;
                            option.textContent = seg.name + ' (' + (seg.user_count || 0) + '人)';
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Segments load error:', error);
            }
        }

        function updateTargetType() {
            var targetType = document.querySelector('input[name="target_type"]:checked').value;
            var segmentSelector = document.getElementById('segmentSelector');
            if (targetType === 'segment') {
                segmentSelector.style.display = 'block';
                updateTargetCount();
            } else {
                segmentSelector.style.display = 'none';
            }
        }

        async function updateTargetCount() {
            var segmentId = document.getElementById('segmentSelect').value;
            var countDiv = document.getElementById('targetCount');
            if (!segmentId) { countDiv.textContent = ''; return; }
            try {
                var payload = { segment_id: parseInt(segmentId) };
                if (pageTenantId) payload.tenant_id = pageTenantId;
                var response = await apiPost('/api/segments?action=preview', payload);
                if (response && response.ok) {
                    var result = await response.json();
                    countDiv.textContent = '対象ユーザー数: ' + (result.data.user_count || 0) + '人';
                }
            } catch (error) {
                console.error('Target count error:', error);
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            var title = document.getElementById('title').value;
            var body = document.getElementById('body').value;
            var url = document.getElementById('url').value;
            var send_at = document.getElementById('send_at').value;
            var targetType = document.querySelector('input[name="target_type"]:checked').value;
            var segmentId = document.getElementById('segmentSelect').value;

            if (!title || !body || !send_at) { showFormError('タイトル、本文、送信日時は必須です'); return; }
            if (targetType === 'segment' && !segmentId) { showFormError('セグメントを選択してください'); return; }

            var payload = { title, body, url, send_at, target_type: targetType };
            if (targetType === 'segment') payload.target_segment_id = parseInt(segmentId);
            if (pageTenantId) payload.tenant_id = pageTenantId;

            var submitBtn = document.querySelector('button[type="submit"]');
            setButtonLoading(submitBtn, true, '作成中...');

            try {
                var response = await apiPost('/api/notifications/create', payload);
                var result = await response.json();
                if (result.status === 'ok') {
                    toast('success', '通知を作成しました');
                    setTimeout(function() { window.location.href = '/admin'; }, 1200);
                } else {
                    showFormError(result.message || '作成に失敗しました');
                    setButtonLoading(submitBtn, false);
                }
            } catch (error) {
                showFormError('エラーが発生しました: ' + error.message);
                setButtonLoading(submitBtn, false);
            }
        }
    </script>
</body>
</html>
