<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥ä½œæˆ - Narukami ç®¡ç†ç”»é¢</title>
    <link rel="stylesheet" href="/admin/admin.css">
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" class="login-screen" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); align-items: center; justify-content: center; z-index: 1000;">
        <div class="login-box" style="background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 300px;">
            <h1 style="margin: 0 0 20px 0; text-align: center; color: #333;">Narukami ç®¡ç†ç”»é¢</h1>
            <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="password-input" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
            <button id="loginButton" class="btn-primary" style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="loginError" class="error-message" style="display: none; color: red; margin-top: 10px; text-align: center;"></div>
        </div>
    </div>

    <!-- ä½œæˆç”»é¢ -->
    <div id="createScreen" class="create-screen" style="display: none;">
        <header class="header">
            <h1>é€šçŸ¥ä½œæˆ</h1>
            <a href="/admin" class="btn-secondary">æˆ»ã‚‹</a>
        </header>

        <div class="container">
            <form id="createForm" class="create-form">
                <div class="form-group">
                    <label for="title">ã‚¿ã‚¤ãƒˆãƒ« <span class="required">*</span></label>
                    <input type="text" id="title" name="title" required maxlength="100" class="form-input">
                    <span class="form-hint">æœ€å¤§100æ–‡å­—</span>
                </div>

                <div class="form-group">
                    <label for="body">æœ¬æ–‡ <span class="required">*</span></label>
                    <textarea id="body" name="body" required maxlength="500" rows="5" class="form-textarea"></textarea>
                    <span class="form-hint">2ã€œ3è¡Œæ¨å¥¨ã€æœ€å¤§500æ–‡å­—</span>
                </div>

                <div class="form-group">
                    <label for="url">ã‚¿ãƒƒãƒ—æ™‚ã®URLï¼ˆçœç•¥å¯ï¼‰</label>
                    <input type="url" id="url" name="url" class="form-input" placeholder="https://example.com">
                </div>

                <div class="form-group">
                    <label>é€ä¿¡å¯¾è±¡</label>
                    <div class="target-selector">
                        <label class="radio-label">
                            <input type="radio" name="target_type" value="all" checked onchange="updateTargetType()">
                            å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="target_type" value="segment" onchange="updateTargetType()">
                            ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæŒ‡å®š
                        </label>
                    </div>
                    
                    <div id="segmentSelector" style="display: none; margin-top: 15px;">
                        <select id="segmentSelect" class="form-input" onchange="updateTargetCount()">
                            <option value="">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’é¸æŠ...</option>
                        </select>
                        <div id="targetCount" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="send_at">é€ä¿¡æ—¥æ™‚ <span class="required">*</span></label>
                    <input type="datetime-local" id="send_at" name="send_at" required class="form-input">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">äºˆç´„ä½œæˆ</button>
                    <a href="/admin" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
                </div>

                <div id="formError" class="error-message" style="display: none;"></div>
                <div id="formSuccess" class="success-message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <script src="/admin/admin.js"></script>
    <script>
        let segments = [];

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadSegments() {
            try {
                const password = localStorage.getItem('adminPassword');
                const url = currentTenantId 
                    ? `/api/segments?action=list&tenant_id=${currentTenantId}`
                    : '/api/segments?action=list';
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${password}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    segments = result.data || [];
                    
                    const select = document.getElementById('segmentSelect');
                    if (select) {
                        select.innerHTML = '<option value="">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’é¸æŠ...</option>';
                        segments.forEach(seg => {
                            const option = document.createElement('option');
                            option.value = seg.id;
                            option.textContent = `${seg.name} (${seg.user_count || 0}äºº)`;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Segments load error:', error);
            }
        }

        // é€ä¿¡å¯¾è±¡ã‚¿ã‚¤ãƒ—å¤‰æ›´
        function updateTargetType() {
            const targetType = document.querySelector('input[name="target_type"]:checked').value;
            const segmentSelector = document.getElementById('segmentSelector');
            
            if (targetType === 'segment') {
                segmentSelector.style.display = 'block';
                updateTargetCount();
            } else {
                segmentSelector.style.display = 'none';
            }
        }

        // å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°æ›´æ–°
        async function updateTargetCount() {
            const segmentId = document.getElementById('segmentSelect').value;
            const countDiv = document.getElementById('targetCount');
            
            if (!segmentId) {
                countDiv.textContent = '';
                return;
            }

            try {
                const password = localStorage.getItem('adminPassword');
                const payload = { segment_id: parseInt(segmentId) };
                if (currentTenantId) {
                    payload.tenant_id = currentTenantId;
                }
                const response = await fetch('/api/segments?action=preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${password}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    const count = result.data.user_count || 0;
                    countDiv.textContent = `ğŸ“Š å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${count.toLocaleString('ja-JP')}äºº`;
                }
            } catch (error) {
                console.error('Target count error:', error);
            }
        }

        // ãƒ†ãƒŠãƒ³ãƒˆIDã‚’å–å¾—ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ï¼‰
        let currentTenantId = null;
        async function loadTenantId() {
            try {
                const domain = window.location.hostname;
                const password = localStorage.getItem('adminPassword');
                const res = await fetch(`/api/stats?domain=${encodeURIComponent(domain)}`, {
                    headers: { 'Authorization': `Bearer ${password}` }
                });
                if (res.ok) {
                    const result = await res.json();
                    if (result.status === 'ok' && result.data.tenant) {
                        currentTenantId = result.data.tenant.id;
                        console.log('Tenant ID loaded:', currentTenantId);
                    }
                }
            } catch (err) {
                console.error('Failed to load tenant ID:', err);
            }
        }

        // create.htmlç”¨ã®ç”»é¢è¡¨ç¤ºé–¢æ•°ï¼ˆadmin.jsã®showLoginScreen/showMainScreenã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼‰
        // admin.jsãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã€å°‘ã—é…å»¶ã•ã›ã‚‹
        function overrideScreenFunctions() {
            if (typeof window.showLoginScreen === 'function') {
                window.showLoginScreen = function() {
                    const loginScreen = document.getElementById('loginScreen');
                    const createScreen = document.getElementById('createScreen');
                    if (loginScreen) loginScreen.style.display = 'flex';
                    if (createScreen) createScreen.style.display = 'none';
                };
            }
            
            if (typeof window.showMainScreen === 'function') {
                window.showMainScreen = function() {
                    const loginScreen = document.getElementById('loginScreen');
                    const createScreen = document.getElementById('createScreen');
                    if (loginScreen) loginScreen.style.display = 'none';
                    if (createScreen) createScreen.style.display = 'block';
                    // create.htmlã§ã¯loadDashboard()ã‚’å‘¼ã°ãªã„
                    // ä»£ã‚ã‚Šã«loadTenantId()ã¨loadSegments()ã‚’å‘¼ã¶
                    loadTenantId().then(() => loadSegments());
                };
            }
        }

        // ä½œæˆç”»é¢ç”¨ã®åˆæœŸåŒ–
        // å³åº§ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤ºï¼ˆJavaScriptãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹å‰ã§ã‚‚è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
        (function() {
            const loginScreen = document.getElementById('loginScreen');
            const createScreen = document.getElementById('createScreen');
            if (loginScreen) {
                loginScreen.style.display = 'flex';
            }
            if (createScreen) {
                createScreen.style.display = 'none';
            }
        })();

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¨ä½œæˆç”»é¢ã®çŠ¶æ…‹ã‚’ç¢ºèª
                const loginScreen = document.getElementById('loginScreen');
                const createScreen = document.getElementById('createScreen');
                if (!loginScreen || !createScreen) {
                    console.error('Required elements not found');
                    return;
                }
                
                // admin.jsãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã®ã‚’å¾…ã¤
                let retryCount = 0;
                const maxRetries = 20;
                const checkAdminJs = setInterval(async () => {
                    if (typeof checkAuth === 'function') {
                        clearInterval(checkAdminJs);
                        
                        // ç”»é¢è¡¨ç¤ºé–¢æ•°ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
                        overrideScreenFunctions();
                        
                        // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚Œã°èªè¨¼ã•ã‚Œã‚‹ï¼‰
                        try {
                            const authenticated = await checkAuth();
                            
                            if (authenticated) {
                                await loadTenantId();
                                await loadSegments();
                            }
                        } catch (authError) {
                            console.error('Auth check error:', authError);
                        }
                        
                        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆadmin.jsã®loginé–¢æ•°ã‚’ä½¿ç”¨ï¼‰
                        const loginButton = document.getElementById('loginButton');
                        if (loginButton) {
                            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ 
                            loginButton.replaceWith(loginButton.cloneNode(true));
                            const newLoginButton = document.getElementById('loginButton');
                            newLoginButton.addEventListener('click', async () => {
                                if (typeof login === 'function') {
                                    await login();
                                    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã€create.htmlã®å‡¦ç†ã‚’å®Ÿè¡Œ
                                    setTimeout(async () => {
                                        await loadTenantId();
                                        await loadSegments();
                                    }, 100);
                                }
                            });
                        }
                        
                        // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
                        const passwordInput = document.getElementById('passwordInput');
                        if (passwordInput) {
                            passwordInput.addEventListener('keypress', async (e) => {
                                if (e.key === 'Enter' && typeof login === 'function') {
                                    await login();
                                    setTimeout(async () => {
                                        await loadTenantId();
                                        await loadSegments();
                                    }, 100);
                                }
                            });
                        }
                    } else {
                        retryCount++;
                        if (retryCount >= maxRetries) {
                            clearInterval(checkAdminJs);
                            console.error('admin.js not loaded after retries');
                            // admin.jsãŒèª­ã¿è¾¼ã¾ã‚Œãªãã¦ã‚‚ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¯è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
                        }
                    }
                }, 100);
            } catch (error) {
                console.error('Initialization error:', error);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¯è¡¨ç¤º
                const loginScreen = document.getElementById('loginScreen');
                const createScreen = document.getElementById('createScreen');
                if (loginScreen) loginScreen.style.display = 'flex';
                if (createScreen) createScreen.style.display = 'none';
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
            document.getElementById('createForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const title = document.getElementById('title').value;
                const body = document.getElementById('body').value;
                const url = document.getElementById('url').value;
                const send_at = document.getElementById('send_at').value;
                const targetType = document.querySelector('input[name="target_type"]:checked').value;
                const segmentId = document.getElementById('segmentSelect').value;

                if (!title || !body || !send_at) {
                    showError('ã‚¿ã‚¤ãƒˆãƒ«ã€æœ¬æ–‡ã€é€ä¿¡æ—¥æ™‚ã¯å¿…é ˆã§ã™');
                    return;
                }

                if (targetType === 'segment' && !segmentId) {
                    showError('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }

                const payload = {
                    title,
                    body,
                    url,
                    send_at,
                    target_type: targetType
                };

                if (targetType === 'segment') {
                    payload.target_segment_id = parseInt(segmentId);
                }
                
                // tenant_idã‚’è¿½åŠ 
                if (currentTenantId) {
                    payload.tenant_id = currentTenantId;
                }

                try {
                    const response = await fetch('/api/notifications/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('adminPassword')}`
                        },
                        body: JSON.stringify(payload)
                    });

                    let result;
                    try {
                        result = await response.json();
                    } catch (jsonError) {
                        const text = await response.text();
                        console.error('Invalid JSON response:', text);
                        showError('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä¸æ­£ã§ã™: ' + text.substring(0, 100));
                        return;
                    }

                    if (result.status === 'ok') {
                        showSuccess('é€šçŸ¥ã‚’ä½œæˆã—ã¾ã—ãŸ');
                        setTimeout(() => {
                            window.location.href = '/admin';
                        }, 1000);
                    } else {
                        showError(result.message || 'ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.error('Request error:', error);
                    showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            });
            } else {
                console.error('createForm element not found');
            }
        });

            function showError(message) {
                const errorDiv = document.getElementById('formError');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                document.getElementById('formSuccess').style.display = 'none';
            }

            function showSuccess(message) {
                const successDiv = document.getElementById('formSuccess');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                document.getElementById('formError').style.display = 'none';
            }
        });
    </script>
</body>
</html>
