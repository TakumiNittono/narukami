<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通知作成 - Narukami 管理画面</title>
    <link rel="stylesheet" href="/admin/admin.css">
</head>
<body>
    <!-- ログイン画面 -->
    <div id="loginScreen" class="login-screen" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); align-items: center; justify-content: center; z-index: 1000;">
        <div class="login-box" style="background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 300px;">
            <h1 style="margin: 0 0 20px 0; text-align: center; color: #333; font-size: 24px;">Narukami 管理画面</h1>
            <input type="password" id="passwordInput" placeholder="パスワード" class="password-input" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px;">
            <button id="loginButton" class="btn-primary" style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">ログイン</button>
            <div id="loginError" class="error-message" style="display: none; color: red; margin-top: 10px; text-align: center;"></div>
        </div>
    </div>

    <!-- 作成画面 -->
    <div id="createScreen" class="create-screen" style="display: none;">
        <header class="header">
            <h1>通知作成</h1>
            <a href="/admin" class="btn-secondary">戻る</a>
        </header>

        <div class="container">
            <form id="createForm" class="create-form">
                <div class="form-group">
                    <label for="title">タイトル <span class="required">*</span></label>
                    <input type="text" id="title" name="title" required maxlength="100" class="form-input">
                    <span class="form-hint">最大100文字</span>
                </div>

                <div class="form-group">
                    <label for="body">本文 <span class="required">*</span></label>
                    <textarea id="body" name="body" required maxlength="500" rows="5" class="form-textarea"></textarea>
                    <span class="form-hint">2〜3行推奨、最大500文字</span>
                </div>

                <div class="form-group">
                    <label for="url">タップ時のURL（省略可）</label>
                    <input type="url" id="url" name="url" class="form-input" placeholder="https://example.com">
                </div>

                <div class="form-group">
                    <label>送信対象</label>
                    <div class="target-selector">
                        <label class="radio-label">
                            <input type="radio" name="target_type" value="all" checked onchange="updateTargetType()">
                            全ユーザー
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="target_type" value="segment" onchange="updateTargetType()">
                            セグメント指定
                        </label>
                    </div>
                    
                    <div id="segmentSelector" style="display: none; margin-top: 15px;">
                        <select id="segmentSelect" class="form-input" onchange="updateTargetCount()">
                            <option value="">セグメントを選択...</option>
                        </select>
                        <div id="targetCount" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="send_at">送信日時 <span class="required">*</span></label>
                    <input type="datetime-local" id="send_at" name="send_at" required class="form-input">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">予約作成</button>
                    <a href="/admin" class="btn-secondary">キャンセル</a>
                </div>

                <div id="formError" class="error-message" style="display: none;"></div>
                <div id="formSuccess" class="success-message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <script src="/admin/admin.js"></script>
    <script>
        var segments = [];
        // currentTenantIdはadmin.jsで既に宣言されているので、ここでは宣言しない
        if (typeof currentTenantId === 'undefined') {
            window.currentTenantId = null;
        }

        // ========== ヘルパー関数 ==========

        function showError(message) {
            var errorDiv = document.getElementById('formError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
            var successDiv = document.getElementById('formSuccess');
            if (successDiv) successDiv.style.display = 'none';
        }

        function showSuccess(message) {
            var successDiv = document.getElementById('formSuccess');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
            }
            var errorDiv = document.getElementById('formError');
            if (errorDiv) errorDiv.style.display = 'none';
        }

        function showCreateScreen() {
            var ls = document.getElementById('loginScreen');
            var cs = document.getElementById('createScreen');
            if (ls) ls.style.display = 'none';
            if (cs) cs.style.display = 'block';
        }

        function showLoginScreenLocal() {
            var ls = document.getElementById('loginScreen');
            var cs = document.getElementById('createScreen');
            if (ls) ls.style.display = 'flex';
            if (cs) cs.style.display = 'none';
        }

        async function loadTenantId() {
            try {
                var password = localStorage.getItem('adminPassword');
                var res = await fetch('/api/stats?domain=' + encodeURIComponent(window.location.hostname), {
                    headers: { 'Authorization': 'Bearer ' + password }
                });
                if (res.ok) {
                    var result = await res.json();
                    if (result.status === 'ok' && result.data && result.data.tenant) {
                        window.currentTenantId = result.data.tenant.id;
                    }
                }
            } catch (err) {
                console.error('Failed to load tenant ID:', err);
            }
        }

        async function loadSegments() {
            try {
                var password = localStorage.getItem('adminPassword');
                var tenantId = window.currentTenantId || currentTenantId;
                var url = tenantId
                    ? '/api/segments?action=list&tenant_id=' + tenantId
                    : '/api/segments?action=list';
                var response = await fetch(url, {
                    headers: { 'Authorization': 'Bearer ' + password }
                });
                if (response.ok) {
                    var result = await response.json();
                    segments = result.data || [];
                    var select = document.getElementById('segmentSelect');
                    if (select) {
                        select.innerHTML = '<option value="">セグメントを選択...</option>';
                        segments.forEach(function(seg) {
                            var option = document.createElement('option');
                            option.value = seg.id;
                            option.textContent = seg.name + ' (' + (seg.user_count || 0) + '人)';
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Segments load error:', error);
            }
        }

        function updateTargetType() {
            var targetType = document.querySelector('input[name="target_type"]:checked').value;
            var segmentSelector = document.getElementById('segmentSelector');
            if (targetType === 'segment') {
                segmentSelector.style.display = 'block';
                updateTargetCount();
            } else {
                segmentSelector.style.display = 'none';
            }
        }

        async function updateTargetCount() {
            var segmentId = document.getElementById('segmentSelect').value;
            var countDiv = document.getElementById('targetCount');
            if (!segmentId) {
                countDiv.textContent = '';
                return;
            }
            try {
                var password = localStorage.getItem('adminPassword');
                var payload = { segment_id: parseInt(segmentId) };
                var tenantId = window.currentTenantId || currentTenantId;
                if (tenantId) payload.tenant_id = tenantId;
                var response = await fetch('/api/segments?action=preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + password },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    var result = await response.json();
                    var count = result.data.user_count || 0;
                    countDiv.textContent = '対象ユーザー数: ' + count + '人';
                }
            } catch (error) {
                console.error('Target count error:', error);
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            var title = document.getElementById('title').value;
            var body = document.getElementById('body').value;
            var url = document.getElementById('url').value;
            var send_at = document.getElementById('send_at').value;
            var targetType = document.querySelector('input[name="target_type"]:checked').value;
            var segmentId = document.getElementById('segmentSelect').value;

            if (!title || !body || !send_at) {
                showError('タイトル、本文、送信日時は必須です');
                return;
            }

            if (targetType === 'segment' && !segmentId) {
                showError('セグメントを選択してください');
                return;
            }

            var payload = {
                title: title,
                body: body,
                url: url,
                send_at: send_at,
                target_type: targetType
            };

            if (targetType === 'segment') {
                payload.target_segment_id = parseInt(segmentId);
            }
            var tenantId = window.currentTenantId || currentTenantId;
            if (tenantId) {
                payload.tenant_id = tenantId;
            }

            try {
                var response = await fetch('/api/notifications/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('adminPassword')
                    },
                    body: JSON.stringify(payload)
                });

                var result = await response.json();

                if (result.status === 'ok') {
                    showSuccess('通知を作成しました');
                    setTimeout(function() {
                        window.location.href = '/admin';
                    }, 1000);
                } else {
                    showError(result.message || '作成に失敗しました');
                }
            } catch (error) {
                console.error('Request error:', error);
                showError('エラーが発生しました: ' + error.message);
            }
        }

        async function doLogin() {
            var password = document.getElementById('passwordInput').value;
            var errorDiv = document.getElementById('loginError');

            if (!password) {
                if (errorDiv) { errorDiv.textContent = 'パスワードを入力してください'; errorDiv.style.display = 'block'; }
                return;
            }

            try {
                var response = await fetch('/api/stats', {
                    headers: { 'Authorization': 'Bearer ' + password }
                });

                if (response.ok) {
                    localStorage.setItem('adminPassword', password);
                    showCreateScreen();
                    await loadTenantId();
                    await loadSegments();
                } else {
                    if (errorDiv) { errorDiv.textContent = 'パスワードが正しくありません'; errorDiv.style.display = 'block'; }
                }
            } catch (err) {
                if (errorDiv) { errorDiv.textContent = 'エラーが発生しました'; errorDiv.style.display = 'block'; }
            }
        }

        // ========== 初期化 ==========

        document.addEventListener('DOMContentLoaded', async function() {
            // ログインボタン
            var loginButton = document.getElementById('loginButton');
            if (loginButton) {
                loginButton.addEventListener('click', doLogin);
            }

            // Enterキーでログイン
            var passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') doLogin();
                });
            }

            // フォーム送信
            var createForm = document.getElementById('createForm');
            if (createForm) {
                createForm.addEventListener('submit', handleFormSubmit);
            }

            // 既にログイン済みかチェック
            var password = localStorage.getItem('adminPassword');
            if (password) {
                try {
                    var response = await fetch('/api/stats', {
                        headers: { 'Authorization': 'Bearer ' + password }
                    });
                    if (response.ok) {
                        showCreateScreen();
                        await loadTenantId();
                        await loadSegments();
                    } else {
                        showLoginScreenLocal();
                    }
                } catch (err) {
                    showLoginScreenLocal();
                }
            } else {
                showLoginScreenLocal();
            }
        });
    </script>
</body>
</html>
