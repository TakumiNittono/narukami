<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ユーザー管理 - Narukami 管理画面</title>
    <link rel="stylesheet" href="/admin/admin.css">
    <style>
        .users-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .users-header h1 {
            margin: 0;
            font-size: 28px;
        }

        .users-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #666;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .users-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }

        .users-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .user-id {
            font-weight: 600;
            color: #007bff;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .btn-detail {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-detail:hover {
            background: #0056b3;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 6px;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-delete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .actions-cell {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            background: #f8f9fa;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            font-weight: 600;
            color: #007bff;
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .user-detail-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .detail-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .detail-stat .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-stat .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .events-list {
            margin-top: 20px;
        }

        .event-item {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .event-type.sent {
            background: #d1ecf1;
            color: #0c5460;
        }

        .event-type.open {
            background: #d4edda;
            color: #155724;
        }

        .event-type.click {
            background: #cce5ff;
            color: #004085;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="admin-nav-root"></div>

    <!-- メイン画面 -->
    <div id="mainScreen" class="main-screen admin-page">
        <header class="header">
            <h1>ユーザー管理</h1>
            <div style="display: flex; gap: 10px;">
                <a href="/admin" class="btn-secondary">ダッシュボード</a>
                <button id="logoutButton" class="btn-secondary">ログアウト</button>
            </div>
        </header>

        <div class="users-container">
            <!-- 統計カード -->
            <div class="users-stats" id="usersStats">
                <div class="stat-card">
                    <h3>総ユーザー数</h3>
                    <div class="value" id="totalUsers">-</div>
                </div>
                <div class="stat-card">
                    <h3>平均CTR</h3>
                    <div class="value" id="avgCTR">-</div>
                </div>
            </div>

            <!-- ユーザー一覧テーブル -->
            <div class="users-table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ユーザーID</th>
                            <th>デバイス</th>
                            <th>登録日</th>
                            <th>開封数</th>
                            <th>クリック数</th>
                            <th>CTR</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="7" class="loading">読み込み中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ページネーション -->
            <div class="pagination" id="pagination" style="display: none;">
                <button id="prevPage" onclick="changePage(-1)">前へ</button>
                <span class="current-page" id="currentPage">1</span>
                <span>/</span>
                <span id="totalPages">1</span>
                <button id="nextPage" onclick="changePage(1)">次へ</button>
            </div>
        </div>
    </div>

    <!-- ユーザー詳細モーダル -->
    <div id="userDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ユーザー詳細 #<span id="modalUserId"></span></h2>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="btn-delete" id="modalDeleteBtn" style="margin: 0;">削除</button>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
            </div>
            <div id="userDetailContent">
                <div class="loading">読み込み中...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="/admin/admin.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentDetailUserId = null;
        let pageTenantId = null;

        async function onAdminReady(user) {
            try {
                const result = await (await apiGet('/api/stats?domain=' + encodeURIComponent(window.location.hostname))).json();
                if (result.status === 'ok' && result.data.tenant) {
                    pageTenantId = result.data.tenant.id;
                }
            } catch (err) {
                console.error('Failed to load tenant ID:', err);
            }
            await loadUsers(1);
        }

        async function loadUsers(page = 1) {
            try {
                const url = pageTenantId
                    ? `/api/users?action=list&page=${page}&limit=50&tenant_id=${pageTenantId}`
                    : `/api/users?action=list&page=${page}&limit=50`;

                const result = await (await apiGet(url)).json();

                if (result.status !== 'ok') {
                    throw new Error(result.message || 'Failed to load users');
                }

                const { users, pagination } = result.data;
                currentPage = pagination.page;
                totalPages = pagination.total_pages;

                // 統計を更新
                updateStats(users, pagination.total);

                // テーブルを更新
                renderUsersTable(users);

                // ページネーションを更新
                updatePagination();

            } catch (err) {
                console.error('Error loading users:', err);
                document.getElementById('usersTableBody').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; color: #dc3545;">エラー: ' + err.message + '</td></tr>';
            }
        }

        function updateStats(users, totalUsers) {
            document.getElementById('totalUsers').textContent = totalUsers.toLocaleString();

            if (users.length === 0) {
                document.getElementById('avgCTR').textContent = '0.0%';
                return;
            }

            const totalCTR = users.reduce((sum, u) => sum + (u.stats.ctr || 0), 0);
            const avgCTR = (totalCTR / users.length).toFixed(1);

            document.getElementById('avgCTR').textContent = avgCTR + '%';
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">ユーザーが見つかりません</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const createdDate = new Date(user.created_at).toLocaleDateString('ja-JP');
                const ctr = user.stats.ctr.toFixed(1);

                return `
                    <tr>
                        <td><span class="user-id">#${user.id}</span></td>
                        <td>${escapeHtml(user.device_info)}</td>
                        <td>${createdDate}</td>
                        <td>${user.stats.total_opened}</td>
                        <td>${user.stats.total_clicked}</td>
                        <td>
                            <span class="badge ${user.stats.ctr >= 50 ? 'badge-success' : user.stats.ctr >= 20 ? 'badge-info' : 'badge-warning'}">
                                ${ctr}%
                            </span>
                        </td>
                        <td class="actions-cell">
                            <button class="btn-detail" onclick="showUserDetail(${user.id})">詳細</button>
                            <button class="btn-delete" onclick="deleteUser(${user.id})">削除</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updatePagination() {
            const paginationEl = document.getElementById('pagination');
            if (totalPages <= 1) {
                paginationEl.style.display = 'none';
                return;
            }

            paginationEl.style.display = 'flex';
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                loadUsers(newPage);
            }
        }

        async function showUserDetail(userId) {
            const modal = document.getElementById('userDetailModal');
            const content = document.getElementById('userDetailContent');
            const userIdSpan = document.getElementById('modalUserId');

            modal.style.display = 'block';
            currentDetailUserId = userId;
            userIdSpan.textContent = userId;
            document.getElementById('modalDeleteBtn').onclick = () => deleteUser(userId);
            content.innerHTML = '<div class="loading">読み込み中...</div>';

            try {
                const detailUrl = pageTenantId
                    ? `/api/users?action=detail&user_id=${userId}&tenant_id=${pageTenantId}`
                    : `/api/users?action=detail&user_id=${userId}`;

                const result = await (await apiGet(detailUrl)).json();

                if (result.status !== 'ok') {
                    throw new Error(result.message || 'Failed to load user detail');
                }

                const user = result.data;
                const createdDate = new Date(user.created_at).toLocaleString('ja-JP');

                // イベント履歴を取得
                const eventsUrl = pageTenantId
                    ? `/api/users?action=events&user_id=${userId}&limit=50&tenant_id=${pageTenantId}`
                    : `/api/users?action=events&user_id=${userId}&limit=50`;

                let eventsHtml = '<div class="loading">読み込み中...</div>';
                try {
                    const eventsResult = await (await apiGet(eventsUrl)).json();
                    if (eventsResult.status === 'ok' && eventsResult.data.events.length > 0) {
                        eventsHtml = eventsResult.data.events.map(event => {
                            const eventDate = new Date(event.created_at).toLocaleString('ja-JP');
                            const eventTypeClass = event.event_type === 'sent' ? 'sent' :
                                                  event.event_type === 'open' ? 'open' : 'click';
                            return `
                                <div class="event-item">
                                    <div>
                                        <span class="event-type ${eventTypeClass}">${getEventTypeLabel(event.event_type)}</span>
                                        <span style="margin-left: 10px;">${escapeHtml(event.notification_title)}</span>
                                    </div>
                                    <div style="color: #666; font-size: 12px;">${eventDate}</div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        eventsHtml = '<p style="color: #666; text-align: center; padding: 20px;">イベント履歴がありません</p>';
                    }
                } catch (eventsErr) {
                    eventsHtml = '<p style="color: #666; text-align: center; padding: 20px;">イベント履歴がありません</p>';
                }

                content.innerHTML = `
                    <div class="user-detail-stats">
                        <div class="detail-stat">
                            <div class="label">デバイス</div>
                            <div class="value">${escapeHtml(user.device_info)}</div>
                        </div>
                        <div class="detail-stat">
                            <div class="label">登録日</div>
                            <div class="value" style="font-size: 14px;">${createdDate}</div>
                        </div>
                        <div class="detail-stat">
                            <div class="label">受信数</div>
                            <div class="value">${user.stats.total_sent}</div>
                        </div>
                        <div class="detail-stat">
                            <div class="label">開封数</div>
                            <div class="value">${user.stats.total_opened}</div>
                        </div>
                        <div class="detail-stat">
                            <div class="label">クリック数</div>
                            <div class="value">${user.stats.total_clicked}</div>
                        </div>
                        <div class="detail-stat">
                            <div class="label">CTR</div>
                            <div class="value">${user.stats.ctr.toFixed(1)}%</div>
                        </div>
                    </div>
                    <div class="events-list">
                        <h3>イベント履歴</h3>
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 10px;">
                            ${eventsHtml}
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('Error loading user detail:', err);
                content.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">エラー: ' + err.message + '</div>';
            }
        }

        function closeModal() {
            document.getElementById('userDetailModal').style.display = 'none';
            currentDetailUserId = null;
        }

        function getEventTypeLabel(eventType) {
            const labels = {
                'sent': '送信',
                'open': '開封',
                'click': 'クリック'
            };
            return labels[eventType] || eventType;
        }

        async function deleteUser(userId) {
            const msg = `ユーザー #${userId} を削除しますか？\n\nこの操作は取り消せません。通知履歴・ステップ配信進捗も削除されます。`;
            if (!confirm(msg)) return;

            try {
                const body = { user_id: userId };
                const url = pageTenantId
                    ? `/api/users?action=delete&tenant_id=${pageTenantId}`
                    : `/api/users?action=delete`;

                const result = await apiPost(url, body);

                if (result.status !== 'ok') {
                    const errMsg = result.detail ? `${result.message}: ${result.detail}` : (result.message || '削除に失敗しました');
                    throw new Error(errMsg);
                }

                toast('success', '削除完了', 'ユーザーを削除しました');
                closeModal();
                await loadUsers(currentPage);
            } catch (err) {
                console.error('Error deleting user:', err);
                toast('error', 'エラー', 'エラー: ' + err.message);
            }
        }

        // モーダル外クリックで閉じる
        window.onclick = function(event) {
            const modal = document.getElementById('userDetailModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
