<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† - é‹å–¶ç®¡ç†äº‹å‹™å±€</title>
    <link rel="stylesheet" href="/admin/admin.css">
</head>
<body>
    <div id="admin-nav-root"></div>

    <div class="admin-page">
        <div class="container">

            <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="admin-page-header" style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <h1 class="admin-page-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h1>
                    <p class="admin-page-subtitle">ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¢ºèªãƒ»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç®¡ç†ã‚’è¡Œã„ã¾ã™</p>
                </div>
                <button class="btn btn-danger btn-sm" onclick="deleteAllUsers()" style="white-space:nowrap;">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤</button>
            </div>

            <!-- KPIã‚«ãƒ¼ãƒ‰ -->
            <div class="kpi-cards" style="grid-template-columns: repeat(auto-fit, minmax(200px, 240px));">
                <div class="kpi-card kpi-card--users">
                    <div class="kpi-icon-wrap">ğŸ‘¤</div>
                    <div class="kpi-body">
                        <div class="kpi-label">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</div>
                        <div class="kpi-value" id="totalUsers">-</div>
                    </div>
                </div>
                <div class="kpi-card kpi-card--ctr">
                    <div class="kpi-icon-wrap">ğŸ–±</div>
                    <div class="kpi-body">
                        <div class="kpi-label">å¹³å‡CTR</div>
                        <div class="kpi-value" id="avgCTR">-</div>
                    </div>
                </div>
            </div>

            <!-- ã‚¿ãƒ– -->
            <div class="tabs-nav">
                <button class="tab-btn active" onclick="switchTab('users', this)">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</button>
                <button class="tab-btn" onclick="switchTab('segments', this)">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç®¡ç†</button>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚¿ãƒ– -->
            <div id="tab-users" class="tab-panel active">
                <div class="card">
                    <!-- é¸æŠã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
                    <div id="selectionBar" style="display:none; padding:10px 16px; background:#EEF2FF; border-bottom:1px solid var(--color-border); display:none; align-items:center; gap:12px;">
                        <span id="selectionCount" style="font-size:13px; font-weight:600; color:var(--color-primary);"></span>
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedUsers()">é¸æŠã‚’å‰Šé™¤</button>
                        <button class="btn btn-secondary btn-sm" onclick="clearSelection()">é¸æŠè§£é™¤</button>
                    </div>
                    <div class="card-body" style="padding:0;">
                        <div class="table-wrap">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th style="width:40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
                                        <th>ID</th>
                                        <th>ãƒ‡ãƒã‚¤ã‚¹</th>
                                        <th>ç™»éŒ²æ—¥</th>
                                        <th>é–‹å°æ•°</th>
                                        <th>ã‚¯ãƒªãƒƒã‚¯æ•°</th>
                                        <th>CTR</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr><td colspan="8" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-bar" id="pagination" style="display:none;">
                            <button id="prevPage" onclick="changePage(-1)">â† å‰ã¸</button>
                            <span class="page-info"><strong id="currentPage">1</strong> / <span id="totalPages">1</span></span>
                            <button id="nextPage" onclick="changePage(1)">æ¬¡ã¸ â†’</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç®¡ç†ã‚¿ãƒ– -->
            <div id="tab-segments" class="tab-panel">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä¸€è¦§</span>
                        <button class="btn btn-primary btn-sm" onclick="openSegmentModal()">+ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä½œæˆ</button>
                    </div>
                    <div class="card-body" id="segmentsList">
                        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="userModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span class="modal-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´° #<span id="modalUserId"></span></span>
                <button class="modal-close" onclick="closeModal('userModal')">âœ•</button>
            </div>
            <div class="modal-body" id="userDetailContent">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" id="modalDeleteBtn">å‰Šé™¤</button>
                <button class="btn btn-secondary btn-sm" onclick="closeModal('userModal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="segmentModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span class="modal-title">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä½œæˆ</span>
                <button class="modal-close" onclick="closeModal('segmentModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå <span class="required">*</span></label>
                    <input type="text" id="segName" class="form-input" placeholder="ä¾‹: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼">
                </div>
                <div class="form-group">
                    <label class="form-label">èª¬æ˜</label>
                    <textarea id="segDesc" class="form-textarea" rows="2" placeholder="ã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æ¦‚è¦"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" style="margin-bottom:10px;">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶</label>
                    <div id="conditionsContainer"></div>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addCondition()" style="margin-top:6px;">+ æ¡ä»¶ã‚’è¿½åŠ </button>
                </div>
                <div id="previewResult"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="previewSegment()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                <button class="btn btn-secondary" onclick="closeModal('segmentModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="createSegment()">ä½œæˆã™ã‚‹</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="/admin/admin.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let pageTenantId = null;
        let conditionCounter = 0;
        let selectedUserIds = new Set();

        async function onAdminReady(user) {
            try {
                const result = await (await apiGet('/api/stats?domain=' + encodeURIComponent(window.location.hostname))).json();
                if (result.status === 'ok' && result.data.tenant) {
                    pageTenantId = result.data.tenant.id;
                }
            } catch (err) { console.error('Failed to load tenant ID:', err); }
            await loadUsers(1);
        }

        // ==================== ã‚¿ãƒ– ====================
        function switchTab(name, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
            if (name === 'segments') loadSegments();
        }

        // ==================== ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ ====================
        async function loadUsers(page = 1) {
            try {
                const url = pageTenantId
                    ? `/api/users?action=list&page=${page}&limit=50&tenant_id=${pageTenantId}`
                    : `/api/users?action=list&page=${page}&limit=50`;
                const result = await (await apiGet(url)).json();
                if (result.status !== 'ok') throw new Error(result.message || 'Failed to load users');

                const { users, pagination } = result.data;
                currentPage = pagination.page;
                totalPages = pagination.total_pages;

                updateKPIs(users, pagination.total);
                renderUsersTable(users);
                updatePagination();
            } catch (err) {
                document.getElementById('usersTableBody').innerHTML =
                    `<tr><td colspan="7" style="text-align:center; color:var(--color-danger); padding:24px;">ã‚¨ãƒ©ãƒ¼: ${escapeHtml(err.message)}</td></tr>`;
            }
        }

        function updateKPIs(users, total) {
            document.getElementById('totalUsers').textContent = total.toLocaleString();
            if (users.length === 0) { document.getElementById('avgCTR').textContent = '0.0%'; return; }
            const avg = (users.reduce((s, u) => s + (u.stats.ctr || 0), 0) / users.length).toFixed(1);
            document.getElementById('avgCTR').textContent = avg + '%';
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:var(--color-text-muted); padding:32px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            tbody.innerHTML = users.map(user => {
                const ctr = user.stats.ctr.toFixed(1);
                const ctrClass = user.stats.ctr >= 50 ? 'badge-success' : user.stats.ctr >= 20 ? 'badge-info' : 'badge-warning';
                const checked = selectedUserIds.has(user.id) ? 'checked' : '';
                return `<tr>
                    <td><input type="checkbox" class="user-checkbox" data-id="${user.id}" ${checked} onchange="toggleUserSelect(${user.id}, this.checked)"></td>
                    <td style="font-weight:600; color:var(--color-primary);">#${user.id}</td>
                    <td style="color:var(--color-text-muted); font-size:13px;">${escapeHtml(user.device_info)}</td>
                    <td style="color:var(--color-text-muted); font-size:13px;">${new Date(user.created_at).toLocaleDateString('ja-JP')}</td>
                    <td>${user.stats.total_opened}</td>
                    <td>${user.stats.total_clicked}</td>
                    <td><span class="badge ${ctrClass}">${ctr}%</span></td>
                    <td><button class="btn btn-secondary btn-sm" onclick="showUserDetail(${user.id})">è©³ç´°</button></td>
                </tr>`;
            }).join('');
            updateSelectAllCheckbox();
        }

        function updatePagination() {
            const el = document.getElementById('pagination');
            if (totalPages <= 1) { el.style.display = 'none'; return; }
            el.style.display = 'flex';
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        function changePage(delta) {
            const np = currentPage + delta;
            if (np >= 1 && np <= totalPages) loadUsers(np);
        }

        // ==================== ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ====================
        async function showUserDetail(userId) {
            openModal('userModal');
            document.getElementById('modalUserId').textContent = userId;
            document.getElementById('modalDeleteBtn').onclick = () => deleteUser(userId);
            document.getElementById('userDetailContent').innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';

            try {
                const detailUrl = pageTenantId
                    ? `/api/users?action=detail&user_id=${userId}&tenant_id=${pageTenantId}`
                    : `/api/users?action=detail&user_id=${userId}`;
                const result = await (await apiGet(detailUrl)).json();
                if (result.status !== 'ok') throw new Error(result.message);

                const user = result.data;

                let eventsHtml = '';
                try {
                    const eventsUrl = pageTenantId
                        ? `/api/users?action=events&user_id=${userId}&limit=50&tenant_id=${pageTenantId}`
                        : `/api/users?action=events&user_id=${userId}&limit=50`;
                    const eventsResult = await (await apiGet(eventsUrl)).json();
                    if (eventsResult.status === 'ok' && eventsResult.data.events.length > 0) {
                        eventsHtml = eventsResult.data.events.map(ev => {
                            const typeLabel = { sent: 'é€ä¿¡', open: 'é–‹å°', click: 'ã‚¯ãƒªãƒƒã‚¯' }[ev.event_type] || ev.event_type;
                            const typeClass = { sent: 'badge-info', open: 'badge-success', click: 'badge-primary' }[ev.event_type] || 'badge-neutral';
                            return `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--color-border);">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="badge ${typeClass}">${typeLabel}</span>
                                    <span style="font-size:13px;">${escapeHtml(ev.notification_title)}</span>
                                </div>
                                <span style="font-size:12px; color:var(--color-text-muted);">${new Date(ev.created_at).toLocaleString('ja-JP', {month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})}</span>
                            </div>`;
                        }).join('');
                    } else {
                        eventsHtml = '<p class="no-data">ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    }
                } catch (e) {
                    eventsHtml = '<p class="no-data">ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>';
                }

                document.getElementById('userDetailContent').innerHTML = `
                    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:12px; margin-bottom:20px;">
                        ${[
                            ['ãƒ‡ãƒã‚¤ã‚¹', escapeHtml(user.device_info)],
                            ['ç™»éŒ²æ—¥', new Date(user.created_at).toLocaleDateString('ja-JP')],
                            ['å—ä¿¡æ•°', user.stats.total_sent],
                            ['é–‹å°æ•°', user.stats.total_opened],
                            ['ã‚¯ãƒªãƒƒã‚¯æ•°', user.stats.total_clicked],
                            ['CTR', user.stats.ctr.toFixed(1) + '%'],
                        ].map(([label, val]) => `
                            <div style="background:var(--color-bg); border:1px solid var(--color-border); border-radius:var(--radius); padding:14px; text-align:center;">
                                <div style="font-size:11px; color:var(--color-text-muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:.5px;">${label}</div>
                                <div style="font-size:18px; font-weight:700; color:var(--color-text);">${val}</div>
                            </div>`).join('')}
                    </div>
                    <div>
                        <div style="font-size:13px; font-weight:600; margin-bottom:10px; color:var(--color-text-muted);">ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´</div>
                        ${eventsHtml}
                    </div>`;
            } catch (err) {
                document.getElementById('userDetailContent').innerHTML =
                    `<p style="color:var(--color-danger); text-align:center; padding:20px;">ã‚¨ãƒ©ãƒ¼: ${escapeHtml(err.message)}</p>`;
            }
        }

        async function deleteUser(userId) {
            if (!await confirmDialog('ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤', `ãƒ¦ãƒ¼ã‚¶ãƒ¼ #${userId} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né€šçŸ¥å±¥æ­´ãƒ»ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡é€²æ—ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`, 'å‰Šé™¤ã™ã‚‹', true)) return;
            try {
                const url = pageTenantId ? `/api/users?action=delete&tenant_id=${pageTenantId}` : `/api/users?action=delete`;
                const response = await apiPost(url, { user_id: userId });
                const result = await response.json();
                if (result.status !== 'ok') {
                    throw new Error(result.detail ? `${result.message}: ${result.detail}` : result.message);
                }
                toast('success', 'å‰Šé™¤å®Œäº†', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                closeModal('userModal');
                await loadUsers(currentPage);
            } catch (err) {
                toast('error', 'å‰Šé™¤å¤±æ•—', err.message);
            }
        }

        // ==================== ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç®¡ç† ====================
        async function loadSegments() {
            const container = document.getElementById('segmentsList');
            container.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
            try {
                const url = pageTenantId ? `/api/segments?action=list&tenant_id=${pageTenantId}` : '/api/segments?action=list';
                const result = await (await apiGet(url)).json();
                if (result.status !== 'ok') throw new Error(result.message);

                const segments = result.data || [];
                if (segments.length === 0) {
                    container.innerHTML = `<div class="no-data" style="padding:40px; text-align:center;">
                        <div style="font-size:32px; margin-bottom:12px;">ğŸ“‚</div>
                        <div style="color:var(--color-text-muted);">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
                        <button class="btn btn-primary" style="margin-top:16px;" onclick="openSegmentModal()">+ æœ€åˆã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ</button>
                    </div>`;
                    return;
                }

                container.innerHTML = `<div class="table-wrap">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå</th>
                                <th>èª¬æ˜</th>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</th>
                                <th>ã‚¿ã‚¤ãƒ—</th>
                                <th>ä½œæˆæ—¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${segments.map(seg => `<tr>
                                <td style="font-weight:600;">${escapeHtml(seg.name)}</td>
                                <td style="color:var(--color-text-muted); font-size:13px;">${escapeHtml(seg.description || '-')}</td>
                                <td>${(seg.user_count || 0).toLocaleString()}äºº</td>
                                <td><span class="badge ${seg.is_dynamic ? 'badge-primary' : 'badge-neutral'}">${seg.is_dynamic ? 'å‹•çš„' : 'é™çš„'}</span></td>
                                <td style="color:var(--color-text-muted); font-size:13px;">${new Date(seg.created_at).toLocaleDateString('ja-JP')}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>`;
            } catch (err) {
                container.innerHTML = `<p class="error-message" style="padding:20px;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${escapeHtml(err.message)}</p>`;
            }
        }

        function openSegmentModal() {
            document.getElementById('segName').value = '';
            document.getElementById('segDesc').value = '';
            document.getElementById('conditionsContainer').innerHTML = '';
            document.getElementById('previewResult').innerHTML = '';
            conditionCounter = 0;
            addCondition();
            openModal('segmentModal');
        }

        function addCondition() {
            conditionCounter++;
            const id = conditionCounter;
            const html = `<div class="condition-row" id="cond-${id}">
                <select id="field-${id}" onchange="updateConditionInputs(${id})">
                    <option value="registered_days_ago">ç™»éŒ²æ—¥</option>
                    <option value="device_type">ãƒ‡ãƒã‚¤ã‚¹</option>
                    <option value="browser">ãƒ–ãƒ©ã‚¦ã‚¶</option>
                    <option value="engagement_level">ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</option>
                </select>
                <select id="op-${id}">
                    <option value="lte">ä»¥å†…</option>
                    <option value="gte">ä»¥ä¸Š</option>
                </select>
                <input type="number" id="val-${id}" min="0" placeholder="æ—¥æ•°" style="width:80px;">
                <button class="remove-condition" onclick="removeCondition(${id})">âœ•</button>
            </div>`;
            document.getElementById('conditionsContainer').insertAdjacentHTML('beforeend', html);
        }

        function removeCondition(id) {
            const el = document.getElementById('cond-' + id);
            if (el) el.remove();
        }

        function updateConditionInputs(id) {
            const field = document.getElementById('field-' + id).value;
            const opSel = document.getElementById('op-' + id);
            const valInput = document.getElementById('val-' + id);

            if (field === 'registered_days_ago') {
                opSel.innerHTML = '<option value="lte">ä»¥å†…</option><option value="gte">ä»¥ä¸Šå‰</option>';
                opSel.style.display = '';
                valInput.type = 'number';
                valInput.placeholder = 'æ—¥æ•°';
                valInput.style.display = '';
            } else if (field === 'device_type') {
                opSel.innerHTML = '<option value="eq">ãŒ</option>';
                opSel.style.display = '';
                valInput.type = 'text';
                valInput.placeholder = 'mobile / desktop / tablet';
                valInput.style.display = '';
            } else if (field === 'browser') {
                opSel.innerHTML = '<option value="eq">ãŒ</option>';
                opSel.style.display = '';
                valInput.type = 'text';
                valInput.placeholder = 'Chrome / Safari / Firefox';
                valInput.style.display = '';
            } else if (field === 'engagement_level') {
                opSel.innerHTML = '<option value="eq">ãŒ</option>';
                opSel.style.display = '';
                valInput.type = 'text';
                valInput.placeholder = 'active / inactive';
                valInput.style.display = '';
            }
        }

        function buildFilterConditions() {
            const rows = document.querySelectorAll('.condition-row');
            const conditions = [];
            for (const row of rows) {
                const id = row.id.replace('cond-', '');
                const field = document.getElementById('field-' + id).value;
                const op = document.getElementById('op-' + id).value;
                const rawVal = document.getElementById('val-' + id).value.trim();
                if (!rawVal) continue;
                const value = (field === 'registered_days_ago') ? parseInt(rawVal) : rawVal;
                conditions.push({ field, operator: op, value });
            }
            return { conditions };
        }

        async function previewSegment() {
            const conditions = buildFilterConditions();
            const previewEl = document.getElementById('previewResult');
            previewEl.innerHTML = '<span style="font-size:13px; color:var(--color-text-muted);">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­...</span>';
            try {
                const body = { filter_conditions: conditions };
                if (pageTenantId) body.tenant_id = pageTenantId;
                const response = await apiPost('/api/segments?action=preview', body);
                const result = await response.json();
                if (result.status === 'ok') {
                    previewEl.innerHTML = `<div style="padding:12px 14px; background:var(--color-bg); border:1px solid var(--color-border); border-radius:var(--radius); font-size:14px; margin-top:4px;">
                        å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: <strong style="color:var(--color-primary); font-size:18px;">${result.data.user_count.toLocaleString()}</strong> äºº
                    </div>`;
                } else {
                    previewEl.innerHTML = `<p class="error-message">${escapeHtml(result.message)}</p>`;
                }
            } catch (err) {
                previewEl.innerHTML = `<p class="error-message">ã‚¨ãƒ©ãƒ¼: ${escapeHtml(err.message)}</p>`;
            }
        }

        async function createSegment() {
            const name = document.getElementById('segName').value.trim();
            if (!name) { toast('error', 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            const conditions = buildFilterConditions();
            try {
                const body = { name, description: document.getElementById('segDesc').value.trim(), filter_conditions: conditions };
                if (pageTenantId) body.tenant_id = pageTenantId;
                const response = await apiPost('/api/segments?action=create', body);
                const result = await response.json();
                if (result.status === 'ok') {
                    toast('success', 'ä½œæˆå®Œäº†', `ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã€Œ${name}ã€ã‚’ä½œæˆã—ã¾ã—ãŸ`);
                    closeModal('segmentModal');
                    loadSegments();
                } else {
                    toast('error', 'ä½œæˆå¤±æ•—', result.message);
                }
            } catch (err) {
                toast('error', 'ã‚¨ãƒ©ãƒ¼', err.message);
            }
        }

        // ==================== é¸æŠãƒ»ä¸€æ‹¬å‰Šé™¤ ====================
        function toggleUserSelect(userId, checked) {
            if (checked) {
                selectedUserIds.add(userId);
            } else {
                selectedUserIds.delete(userId);
            }
            updateSelectionBar();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll(el) {
            var checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(function(cb) {
                cb.checked = el.checked;
                var id = parseInt(cb.dataset.id);
                if (el.checked) {
                    selectedUserIds.add(id);
                } else {
                    selectedUserIds.delete(id);
                }
            });
            updateSelectionBar();
        }

        function updateSelectAllCheckbox() {
            var checkboxes = document.querySelectorAll('.user-checkbox');
            var selectAll = document.getElementById('selectAll');
            if (checkboxes.length === 0) { selectAll.checked = false; return; }
            var allChecked = Array.from(checkboxes).every(function(cb) { return cb.checked; });
            var someChecked = Array.from(checkboxes).some(function(cb) { return cb.checked; });
            selectAll.checked = allChecked;
            selectAll.indeterminate = someChecked && !allChecked;
        }

        function updateSelectionBar() {
            var bar = document.getElementById('selectionBar');
            if (selectedUserIds.size > 0) {
                bar.style.display = 'flex';
                document.getElementById('selectionCount').textContent = selectedUserIds.size + 'äººã‚’é¸æŠä¸­';
            } else {
                bar.style.display = 'none';
            }
        }

        function clearSelection() {
            selectedUserIds.clear();
            document.querySelectorAll('.user-checkbox').forEach(function(cb) { cb.checked = false; });
            document.getElementById('selectAll').checked = false;
            document.getElementById('selectAll').indeterminate = false;
            updateSelectionBar();
        }

        async function deleteSelectedUsers() {
            var count = selectedUserIds.size;
            if (count === 0) return;
            if (!await confirmDialog('é¸æŠãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤', count + 'äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\né€šçŸ¥å±¥æ­´ãƒ»ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡é€²æ—ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚', count + 'äººã‚’å‰Šé™¤ã™ã‚‹', true)) return;

            try {
                var ids = Array.from(selectedUserIds);
                var url = pageTenantId ? '/api/users?action=delete-batch&tenant_id=' + pageTenantId : '/api/users?action=delete-batch';
                var response = await apiPost(url, { user_ids: ids });
                var result = await response.json();
                if (result.status !== 'ok') throw new Error(result.message);
                toast('success', 'å‰Šé™¤å®Œäº†', result.data.deleted_count + 'äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                selectedUserIds.clear();
                updateSelectionBar();
                await loadUsers(currentPage);
            } catch (err) {
                toast('error', 'å‰Šé™¤å¤±æ•—', err.message);
            }
        }

        async function deleteAllUsers() {
            var total = document.getElementById('totalUsers').textContent;
            if (!await confirmDialog('å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤', 'å…¨ ' + total + ' äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\né€šçŸ¥å±¥æ­´ãƒ»ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡é€²æ—ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚', 'å…¨ã¦å‰Šé™¤ã™ã‚‹', true)) return;

            try {
                var url = pageTenantId ? '/api/users?action=delete-all&tenant_id=' + pageTenantId : '/api/users?action=delete-all';
                var response = await apiPost(url, {});
                var result = await response.json();
                if (result.status !== 'ok') throw new Error(result.message);
                toast('success', 'å‰Šé™¤å®Œäº†', result.data.deleted_count + 'äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                selectedUserIds.clear();
                updateSelectionBar();
                await loadUsers(1);
            } catch (err) {
                toast('error', 'å‰Šé™¤å¤±æ•—', err.message);
            }
        }

        // ==================== ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š ====================
        function openModal(id) { document.getElementById(id).classList.add('visible'); }
        function closeModal(id) { document.getElementById(id).classList.remove('visible'); }

        window.addEventListener('click', e => {
            ['userModal', 'segmentModal'].forEach(id => {
                const el = document.getElementById(id);
                if (e.target === el) closeModal(id);
            });
        });
    </script>
</body>
</html>
