<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>フルマネージド管理画面 - NARUKAMI</title>
    <link rel="stylesheet" href="admin.css">
    <style>
        .managed-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header-section h1 {
            margin: 0;
            font-size: 28px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--color-surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: var(--color-text-muted);
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: var(--color-text);
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-border);
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--color-text-muted);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tenants-list, .tasks-list, .reports-list {
            background: var(--color-surface);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .list-item {
            padding: 20px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: var(--color-bg); }
        .item-info h4 { margin: 0 0 8px 0; font-size: 18px; }
        .item-info p { margin: 4px 0; color: var(--color-text-muted); font-size: 14px; }
        .item-actions { display: flex; gap: 10px; align-items: center; }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active { background: #ECFDF5; color: #065F46; }
        .status-pending { background: #FFFBEB; color: #92400E; }
        .status-completed { background: #EFF6FF; color: #1E40AF; }
        .status-urgent { background: #FEF2F2; color: #991B1B; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            font-size: 14px;
        }
        .form-group textarea { min-height: 100px; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--color-text-light); }
        /* Analytics tab */
        .analytics-filter-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .analytics-filter-bar label { font-weight: 600; font-size: 14px; color: var(--color-text-muted); }
        .analytics-filter-bar select { padding: 8px 12px; border: 1px solid var(--color-border); border-radius: var(--radius); font-size: 14px; }
        .analytics-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .analytics-stat-card { background: var(--color-surface); border-radius: var(--radius); padding: 16px 20px; box-shadow: var(--shadow-sm); }
        .analytics-stat-card h3 { margin: 0 0 8px 0; font-size: 12px; color: var(--color-text-light); text-transform: uppercase; letter-spacing: 0.5px; }
        .analytics-stat-card .value { font-size: 28px; font-weight: bold; color: var(--color-text); }
        .analytics-stat-card .sub { font-size: 12px; color: var(--color-text-light); margin-top: 4px; }
        .ctr-good { color: var(--color-success); }
        .ctr-mid  { color: var(--color-warning); }
        .ctr-low  { color: var(--color-danger); }
        .analytics-table-wrap { background: var(--color-surface); border-radius: var(--radius); box-shadow: var(--shadow-sm); overflow: hidden; }
        .analytics-table-wrap h3 { margin: 0; padding: 16px 20px; font-size: 16px; border-bottom: 1px solid var(--color-border); }
        table.ctr-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        table.ctr-table thead tr { background: var(--color-bg); }
        table.ctr-table th, table.ctr-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--color-border); }
        table.ctr-table th { font-weight: 600; color: var(--color-text-muted); font-size: 12px; text-transform: uppercase; }
        table.ctr-table tbody tr:hover { background: var(--color-bg); }
        table.ctr-table tbody tr:last-child td { border-bottom: none; }
        .bar-wrap { display: flex; align-items: center; gap: 8px; }
        .bar-bg { flex: 1; height: 8px; background: var(--color-border); border-radius: 4px; overflow: hidden; min-width: 80px; }
        .bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .bar-fill.ctr-color  { background: var(--color-primary); }
        .bar-fill.open-color { background: var(--color-success); }
        .tenant-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; background: #EEF2FF; color: var(--color-primary); font-weight: 600; }
    </style>
</head>
<body>
    <div id="admin-nav-root"></div>
    <div class="admin-page">
    <div class="managed-container">
        <div class="header-section">
            <h1>フルマネージド管理画面</h1>
            <button class="btn btn-primary" onclick="showCreateTenantModal()">新規顧客追加</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>総顧客数</h3>
                <div class="value" id="totalTenants">0</div>
            </div>
            <div class="stat-card">
                <h3>アクティブ顧客</h3>
                <div class="value" id="activeTenants">0</div>
            </div>
            <div class="stat-card">
                <h3>未対応タスク</h3>
                <div class="value" id="pendingTasks">0</div>
            </div>
            <div class="stat-card">
                <h3>今月の総送信数</h3>
                <div class="value" id="monthlySent">0</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('tenants', this)">顧客一覧</button>
            <button class="tab" onclick="switchTab('tasks', this)">タスク管理</button>
            <button class="tab" onclick="switchTab('reports', this)">レポート</button>
            <button class="tab" onclick="switchTab('analytics', this)">CTR分析</button>
        </div>

        <div id="tenants-tab" class="tab-content active">
            <div class="tenants-list" id="tenantsList">
                <div class="empty-state">読み込み中...</div>
            </div>
        </div>

        <div id="tasks-tab" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="showCreateTaskModal()">新規タスク作成</button>
            </div>
            <div class="tasks-list" id="tasksList">
                <div class="empty-state">読み込み中...</div>
            </div>
        </div>

        <div id="reports-tab" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="showCreateReportModal()">新規レポート作成</button>
            </div>
            <div class="reports-list" id="reportsList">
                <div class="empty-state">読み込み中...</div>
            </div>
        </div>

        <div id="analytics-tab" class="tab-content">
            <!-- フィルターバー -->
            <div class="analytics-filter-bar">
                <label>顧客:</label>
                <select id="analyticsTenantFilter" onchange="loadAnalytics()">
                    <option value="">全顧客</option>
                </select>
                <label style="margin-left: 8px;">期間:</label>
                <select id="analyticsPeriodFilter" onchange="renderAnalytics()">
                    <option value="7d">過去7日</option>
                    <option value="30d" selected>過去30日</option>
                    <option value="90d">過去90日</option>
                </select>
            </div>

            <!-- サマリーカード -->
            <div class="analytics-stats-grid" id="analyticsOverview">
                <div class="analytics-stat-card">
                    <h3>平均 CTR</h3>
                    <div class="value" id="statAvgCtr">—</div>
                    <div class="sub">全顧客の加重平均</div>
                </div>
                <div class="analytics-stat-card">
                    <h3>平均開封率</h3>
                    <div class="value" id="statAvgOpen">—</div>
                    <div class="sub">全顧客の加重平均</div>
                </div>
                <div class="analytics-stat-card">
                    <h3>総配信数</h3>
                    <div class="value" id="statTotalSent">—</div>
                    <div class="sub">期間内の合計</div>
                </div>
                <div class="analytics-stat-card">
                    <h3>総クリック数</h3>
                    <div class="value" id="statTotalClicked">—</div>
                    <div class="sub">期間内の合計</div>
                </div>
            </div>

            <!-- 通知別 CTR テーブル -->
            <div class="analytics-table-wrap">
                <h3>通知別パフォーマンス</h3>
                <table class="ctr-table">
                    <thead>
                        <tr>
                            <th>顧客</th>
                            <th>通知タイトル</th>
                            <th>配信数</th>
                            <th>開封数</th>
                            <th>クリック数</th>
                            <th style="min-width:160px;">開封率</th>
                            <th style="min-width:160px;">CTR</th>
                            <th>配信日</th>
                        </tr>
                    </thead>
                    <tbody id="analyticsTableBody">
                        <tr><td colspan="8" style="text-align:center;padding:40px;color:#aaa;">読み込み中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 顧客作成モーダル -->
    <div id="createTenantModal" class="modal">
        <div class="modal-content">
            <h2>新規顧客追加</h2>
            <form id="createTenantForm">
                <div class="form-group">
                    <label>顧客名 *</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>プラン *</label>
                    <select name="plan" required>
                        <option value="basic">Basic (¥10万/月)</option>
                        <option value="pro">Pro (¥25万/月)</option>
                        <option value="enterprise">Enterprise (¥50万/月)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>月間送信上限</label>
                    <input type="number" name="monthly_limit" value="10000">
                </div>
                <div class="form-group">
                    <label>契約開始日</label>
                    <input type="date" name="contract_start_date">
                </div>
                <div class="form-group">
                    <label>契約終了日（任意）</label>
                    <input type="date" name="contract_end_date">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createTenantModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">作成</button>
                </div>
            </form>
        </div>
    </div>

    <!-- タスク作成モーダル -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <h2>新規タスク作成</h2>
            <form id="createTaskForm">
                <div class="form-group">
                    <label>顧客 *</label>
                    <select name="tenant_id" id="taskTenantSelect" required></select>
                </div>
                <div class="form-group">
                    <label>タスクタイプ *</label>
                    <select name="task_type" required>
                        <option value="notification_create">通知作成</option>
                        <option value="step_sequence_create">ステップ配信設計</option>
                        <option value="segment_create">セグメント作成</option>
                        <option value="report_create">レポート作成</option>
                        <option value="optimization">最適化</option>
                        <option value="support">サポート</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>タイトル *</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>説明</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>優先度</label>
                    <select name="priority">
                        <option value="low">低</option>
                        <option value="normal" selected>通常</option>
                        <option value="high">高</option>
                        <option value="urgent">緊急</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>期限</label>
                    <input type="date" name="due_date">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createTaskModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">作成</button>
                </div>
            </form>
        </div>
    </div>

    <!-- レポート作成モーダル -->
    <div id="createReportModal" class="modal">
        <div class="modal-content">
            <h2>新規レポート作成</h2>
            <form id="createReportForm">
                <div class="form-group">
                    <label>顧客 *</label>
                    <select name="tenant_id" id="reportTenantSelect" required></select>
                </div>
                <div class="form-group">
                    <label>レポートタイプ *</label>
                    <select name="report_type" required>
                        <option value="weekly">週次</option>
                        <option value="monthly" selected>月次</option>
                        <option value="custom">カスタム</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>期間開始日 *</label>
                    <input type="date" name="period_start" required>
                </div>
                <div class="form-group">
                    <label>期間終了日 *</label>
                    <input type="date" name="period_end" required>
                </div>
                <div class="form-group">
                    <label>タイトル *</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>サマリー</label>
                    <textarea name="summary"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createReportModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">作成</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 顧客詳細モーダル -->
    <div id="viewTenantModal" class="modal">
        <div class="modal-content">
            <h2>顧客詳細</h2>
            <div id="viewTenantBody"></div>
            <div style="display:flex;justify-content:flex-end;margin-top:20px;">
                <button class="btn btn-secondary" onclick="closeModal('viewTenantModal')">閉じる</button>
            </div>
        </div>
    </div>

    <!-- レポート詳細モーダル -->
    <div id="viewReportModal" class="modal">
        <div class="modal-content">
            <h2 id="viewReportTitle"></h2>
            <div id="viewReportBody"></div>
            <div style="display:flex;justify-content:flex-end;margin-top:20px;">
                <button class="btn btn-secondary" onclick="closeModal('viewReportModal')">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        let tenants = [];
        let tasks = [];
        let reports = [];
        let analyticsData = [];

        async function loadData() {
            await Promise.all([
                loadTenants(),
                loadTasks(),
                loadReports(),
                loadStats()
            ]);
        }

        async function loadTenants() {
            try {
                const res = await apiGet('/api/tenants?action=list');
                if (!res || !res.ok) { toast('error', 'エラー', '顧客一覧の読み込みに失敗しました'); return; }
                const result = await res.json();
                tenants = result.data || [];
                renderTenants();
                // CTR分析タブの顧客セレクトを更新して初期描画
                const sel = document.getElementById('analyticsTenantFilter');
                sel.innerHTML = '<option value="">全顧客</option>' +
                    tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                await loadAnalytics();
            } catch (err) {
                console.error('loadTenants error:', err);
            }
        }

        async function loadTasks() {
            try {
                const res = await apiGet('/api/tasks?action=list');
                if (!res || !res.ok) { toast('error', 'エラー', 'タスク一覧の読み込みに失敗しました'); return; }
                tasks = (await res.json()).data || [];
                renderTasks();
            } catch (err) {
                console.error('loadTasks error:', err);
            }
        }

        async function loadReports() {
            try {
                const res = await apiGet('/api/reports?action=list');
                if (!res || !res.ok) { toast('error', 'エラー', 'レポート一覧の読み込みに失敗しました'); return; }
                reports = (await res.json()).data || [];
                renderReports();
            } catch (err) {
                console.error('loadReports error:', err);
            }
        }

        async function loadStats() {
            try {
                const res = await apiGet('/api/tenants?action=stats');
                if (!res || !res.ok) { console.error('loadStats: failed'); return; }
                const s = (await res.json()).data || {};
                document.getElementById('totalTenants').textContent = s.total_tenants || 0;
                document.getElementById('activeTenants').textContent = s.active_tenants || 0;
                document.getElementById('pendingTasks').textContent = s.pending_tasks || 0;
                document.getElementById('monthlySent').textContent = (s.monthly_sent || 0).toLocaleString();
            } catch (err) {
                console.error('loadStats error:', err);
            }
        }

        async function loadAnalytics() {
            try {
                const tenantId = document.getElementById('analyticsTenantFilter').value;
                const url = tenantId
                    ? `/api/analytics?type=notifications&limit=50&tenant_id=${tenantId}`
                    : `/api/analytics?type=notifications&limit=50`;
                const res = await apiGet(url);
                if (!res || !res.ok) { analyticsData = []; renderAnalytics(); return; }
                const notifications = (await res.json()).data || [];
                analyticsData = notifications.map(n => ({
                    tenant_id: n.tenant_id,
                    tenant_name: tenants.find(t => t.id == n.tenant_id)?.name || '-',
                    title: n.title,
                    sent: n.performance?.total_sent || 0,
                    opened: n.performance?.total_opened || 0,
                    clicked: n.performance?.total_clicked || 0,
                    sent_at: n.send_at ? n.send_at.slice(0, 10) : '-'
                }));
                renderAnalytics();
            } catch (err) {
                console.error('loadAnalytics error:', err);
                analyticsData = [];
                renderAnalytics();
            }
        }

        function periodDays(period) {
            if (period === '7d')  return 7;
            if (period === '90d') return 90;
            return 30;
        }

        function renderAnalytics() {
            const tenantId  = parseInt(document.getElementById('analyticsTenantFilter').value) || null;
            const period    = document.getElementById('analyticsPeriodFilter').value;
            const cutoff    = new Date();
            cutoff.setDate(cutoff.getDate() - periodDays(period));

            // 期間・テナントフィルター
            let rows = analyticsData.filter(n => {
                const d = new Date(n.sent_at);
                if (d < cutoff) return false;
                if (tenantId && n.tenant_id !== tenantId) return false;
                return true;
            });

            // サマリー計算
            const totalSent    = rows.reduce((s, n) => s + n.sent, 0);
            const totalOpened  = rows.reduce((s, n) => s + n.opened, 0);
            const totalClicked = rows.reduce((s, n) => s + n.clicked, 0);
            const avgOpen = totalSent > 0 ? (totalOpened  / totalSent * 100).toFixed(1) : '0.0';
            const avgCtr  = totalSent > 0 ? (totalClicked / totalSent * 100).toFixed(1) : '0.0';

            document.getElementById('statAvgCtr').textContent    = avgCtr + '%';
            document.getElementById('statAvgOpen').textContent   = avgOpen + '%';
            document.getElementById('statTotalSent').textContent = totalSent.toLocaleString();
            document.getElementById('statTotalClicked').textContent = totalClicked.toLocaleString();

            // 色分けクラス
            function ctrClass(val) {
                if (val >= 10) return 'ctr-good';
                if (val >= 5)  return 'ctr-mid';
                return 'ctr-low';
            }

            // テーブル描画
            const tbody = document.getElementById('analyticsTableBody');
            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#aaa;">データがありません</td></tr>';
                return;
            }

            const maxSent = Math.max(...rows.map(n => n.sent));

            tbody.innerHTML = rows.map(n => {
                const openRate = n.sent > 0 ? (n.opened  / n.sent * 100).toFixed(1) : '0.0';
                const ctr      = n.sent > 0 ? (n.clicked / n.sent * 100).toFixed(1) : '0.0';
                const openPct  = n.sent > 0 ? (n.opened  / n.sent * 100) : 0;
                const ctrPct   = n.sent > 0 ? (n.clicked / n.sent * 100) : 0;
                return `
                <tr>
                    <td><span class="tenant-badge">${n.tenant_name}</span></td>
                    <td>${n.title}</td>
                    <td>${n.sent.toLocaleString()}</td>
                    <td>${n.opened.toLocaleString()}</td>
                    <td>${n.clicked.toLocaleString()}</td>
                    <td>
                        <div class="bar-wrap">
                            <div class="bar-bg"><div class="bar-fill open-color" style="width:${Math.min(openPct * 2, 100)}%"></div></div>
                            <span style="min-width:42px;text-align:right">${openRate}%</span>
                        </div>
                    </td>
                    <td>
                        <div class="bar-wrap">
                            <div class="bar-bg"><div class="bar-fill ctr-color" style="width:${Math.min(ctrPct * 5, 100)}%"></div></div>
                            <span class="${ctrClass(parseFloat(ctr))}" style="min-width:42px;text-align:right;font-weight:600">${ctr}%</span>
                        </div>
                    </td>
                    <td style="color:#888">${n.sent_at}</td>
                </tr>`;
            }).join('');
        }

        function renderTenants() {
            const container = document.getElementById('tenantsList');
            if (tenants.length === 0) {
                container.innerHTML = '<div class="empty-state">顧客が登録されていません</div>';
                return;
            }

            container.innerHTML = tenants.map(tenant => `
                <div class="list-item">
                    <div class="item-info">
                        <h4>${tenant.name}</h4>
                        <p>プラン: ${tenant.plan} | 月額: ¥${(tenant.monthly_fee || 0).toLocaleString()}</p>
                        <p>ユーザー数: ${tenant.stats?.user_count || 0} | 通知数: ${tenant.stats?.notification_count || 0} | 未対応タスク: ${tenant.stats?.pending_task_count || 0}</p>
                        <p>送信数: ${tenant.monthly_sent_count || 0} / ${tenant.monthly_limit || 0}</p>
                    </div>
                    <div class="item-actions">
                        <span class="status-badge status-${tenant.status}">${tenant.status}</span>
                        <button class="btn btn-primary" onclick="viewTenant(${tenant.id})">詳細</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state">タスクがありません</div>';
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="list-item">
                    <div class="item-info">
                        <h4>${task.title}</h4>
                        <p>顧客: ${task.tenant_name} | タイプ: ${task.task_type}</p>
                        <p>${task.description || ''}</p>
                        ${task.due_date ? `<p>期限: ${task.due_date}</p>` : ''}
                    </div>
                    <div class="item-actions">
                        <span class="status-badge status-${task.status}">${task.status}</span>
                        ${task.status !== 'completed' ? `<button class="btn btn-success" onclick="completeTask(${task.id})">完了</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderReports() {
            const container = document.getElementById('reportsList');
            if (reports.length === 0) {
                container.innerHTML = '<div class="empty-state">レポートがありません</div>';
                return;
            }

            container.innerHTML = reports.map(report => `
                <div class="list-item">
                    <div class="item-info">
                        <h4>${report.title}</h4>
                        <p>期間: ${report.period_start} ～ ${report.period_end}</p>
                        <p>${report.summary || ''}</p>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-primary" onclick="viewReport(${report.id})">表示</button>
                    </div>
                </div>
            `).join('');
        }

        function switchTab(tabName, el) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            el.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function showCreateTenantModal() {
            document.getElementById('createTenantModal').classList.add('active');
            document.getElementById('createTenantForm').reset();
        }

        function showCreateTaskModal() {
            // 顧客選択肢を設定
            const select = document.getElementById('taskTenantSelect');
            select.innerHTML = tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            
            document.getElementById('createTaskModal').classList.add('active');
            document.getElementById('createTaskForm').reset();
        }

        function showCreateReportModal() {
            // 顧客選択肢を設定
            const select = document.getElementById('reportTenantSelect');
            select.innerHTML = tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            
            document.getElementById('createReportModal').classList.add('active');
            document.getElementById('createReportForm').reset();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        document.getElementById('createTenantForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const res = await apiPost('/api/tenants?action=create', data);
                if (!res) return;
                const result = await res.json();
                if (result.status === 'ok') {
                    toast('success', '顧客追加', '顧客を追加しました');
                    closeModal('createTenantModal');
                    await loadData();
                } else {
                    toast('error', 'エラー', result.message);
                }
            } catch (err) {
                toast('error', 'エラー', err.message);
            }
        });

        document.getElementById('createTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const res = await apiPost('/api/tasks?action=create', data);
                if (!res) return;
                const result = await res.json();
                if (result.status === 'ok') {
                    toast('success', 'タスク作成', 'タスクを作成しました');
                    closeModal('createTaskModal');
                    await loadData();
                } else {
                    toast('error', 'エラー', result.message);
                }
            } catch (err) {
                toast('error', 'エラー', err.message);
            }
        });

        document.getElementById('createReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const res = await apiPost('/api/reports?action=create', data);
                if (!res) return;
                const result = await res.json();
                if (result.status === 'ok') {
                    toast('success', 'レポート作成', 'レポートを作成しました');
                    closeModal('createReportModal');
                    await loadData();
                } else {
                    toast('error', 'エラー', result.message);
                }
            } catch (err) {
                toast('error', 'エラー', err.message);
            }
        });

        async function completeTask(taskId) {
            if (!await confirmDialog('タスク完了', 'このタスクを完了にしますか？', '完了にする')) return;

            try {
                const res = await apiPost('/api/tasks?action=complete', { task_id: taskId });
                if (!res) return;
                const result = await res.json();
                if (result.status === 'ok') {
                    toast('success', '完了', 'タスクを完了にしました');
                    await loadData();
                } else {
                    toast('error', 'エラー', result.message);
                }
            } catch (err) {
                toast('error', 'エラー', err.message);
            }
        }

        function viewTenant(tenantId) {
            const t = tenants.find(t => t.id === tenantId);
            if (!t) return;
            const planLabel = { basic: 'Basic (¥10万/月)', pro: 'Pro (¥25万/月)', enterprise: 'Enterprise (¥50万/月)' }[t.plan] || t.plan;
            document.getElementById('viewTenantBody').innerHTML = `
                <table style="width:100%;border-collapse:collapse;font-size:14px;">
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:10px 0;color:#666;width:40%">顧客名</td><td style="padding:10px 0;font-weight:600;">${escapeHtml(t.name)}</td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:10px 0;color:#666;">プラン</td><td style="padding:10px 0;">${escapeHtml(planLabel)}</td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:10px 0;color:#666;">ステータス</td><td style="padding:10px 0;"><span class="status-badge status-${t.status}">${escapeHtml(t.status)}</span></td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:10px 0;color:#666;">月間上限</td><td style="padding:10px 0;">${(t.monthly_limit||0).toLocaleString()} 件</td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:10px 0;color:#666;">契約開始</td><td style="padding:10px 0;">${t.contract_start_date || '—'}</td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:10px 0;color:#666;">契約終了</td><td style="padding:10px 0;">${t.contract_end_date || '—'}</td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:10px 0;color:#666;">ユーザー数</td><td style="padding:10px 0;">${(t.stats?.user_count||0).toLocaleString()}</td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:10px 0;color:#666;">送信済み通知数</td><td style="padding:10px 0;">${(t.stats?.notification_count||0).toLocaleString()}</td></tr>
                    <tr><td style="padding:10px 0;color:#666;">未対応タスク</td><td style="padding:10px 0;">${t.stats?.pending_task_count||0} 件</td></tr>
                </table>`;
            document.getElementById('viewTenantModal').classList.add('active');
        }

        function viewReport(reportId) {
            const r = reports.find(r => r.id === reportId);
            if (!r) return;
            const typeLabel = { weekly: '週次', monthly: '月次', custom: 'カスタム' }[r.report_type] || r.report_type;
            const tenantName = tenants.find(t => t.id === r.tenant_id)?.name || r.tenant_name || '—';
            document.getElementById('viewReportTitle').textContent = r.title;
            document.getElementById('viewReportBody').innerHTML = `
                <table style="width:100%;border-collapse:collapse;font-size:14px;margin-bottom:16px;">
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:10px 0;color:#666;width:40%">顧客</td><td style="padding:10px 0;font-weight:600;">${escapeHtml(tenantName)}</td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:10px 0;color:#666;">タイプ</td><td style="padding:10px 0;">${escapeHtml(typeLabel)}</td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:10px 0;color:#666;">期間</td><td style="padding:10px 0;">${escapeHtml(r.period_start)} ～ ${escapeHtml(r.period_end)}</td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:10px 0;color:#666;">作成日</td><td style="padding:10px 0;">${r.created_at ? new Date(r.created_at).toLocaleDateString('ja-JP') : '—'}</td></tr>
                </table>
                ${r.summary ? `<div style="background:#f8f9fa;border-radius:8px;padding:16px;font-size:14px;color:#444;line-height:1.7;">${escapeHtml(r.summary)}</div>` : ''}`;
            document.getElementById('viewReportModal').classList.add('active');
        }

        // 初期読み込み
        async function onAdminReady(user) {
            await loadData();
        }
    </script>
    </div><!-- end admin-page -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="/admin/admin.js"></script>
</body>
</html>
