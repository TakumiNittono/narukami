<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ç®¡ç†ç”»é¢ - NARUKAMI</title>
    <link rel="stylesheet" href="admin.css">
    <style>
        .managed-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header-section h1 {
            margin: 0;
            font-size: 28px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #666;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tenants-list, .tasks-list, .reports-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .list-item {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-item:hover {
            background: #f5f5f5;
        }
        .item-info h4 {
            margin: 0 0 8px 0;
            font-size: 18px;
        }
        .item-info p {
            margin: 4px 0;
            color: #666;
            font-size: 14px;
        }
        .item-actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-urgent {
            background: #f8d7da;
            color: #721c24;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            min-height: 100px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .analytics-filter-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .analytics-filter-bar label {
            font-weight: bold;
            font-size: 14px;
            color: #555;
        }
        .analytics-filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .analytics-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .analytics-stat-card {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .analytics-stat-card h3 {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .analytics-stat-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }
        .analytics-stat-card .sub {
            font-size: 12px;
            color: #aaa;
            margin-top: 4px;
        }
        .ctr-good { color: #28a745; }
        .ctr-mid  { color: #fd7e14; }
        .ctr-low  { color: #dc3545; }
        .analytics-table-wrap {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .analytics-table-wrap h3 {
            margin: 0;
            padding: 16px 20px;
            font-size: 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        table.ctr-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        table.ctr-table thead tr {
            background: #f8f9fa;
        }
        table.ctr-table th,
        table.ctr-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        table.ctr-table th {
            font-weight: 600;
            color: #555;
            font-size: 12px;
            text-transform: uppercase;
        }
        table.ctr-table tbody tr:hover {
            background: #fafafa;
        }
        table.ctr-table tbody tr:last-child td {
            border-bottom: none;
        }
        .bar-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .bar-bg {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            min-width: 80px;
        }
        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .bar-fill.ctr-color   { background: #007bff; }
        .bar-fill.open-color  { background: #28a745; }
        .tenant-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            background: #e8f0fe;
            color: #1a56db;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="admin-nav-root"></div>
    <div class="admin-page">
    <div class="managed-container">
        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 12px; margin-bottom: 20px; color: #856404;">
            <strong>ğŸ“Œ ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰</strong> - ã“ã®ç”»é¢ã¯UIè¡¨ç¤ºã®ã¿ã§ã™ã€‚APIæ•°åˆ¶é™ã®ãŸã‚ã€ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚
        </div>
        <div class="header-section">
            <h1>ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ç®¡ç†ç”»é¢</h1>
            <button class="btn btn-primary" onclick="showCreateTenantModal()">æ–°è¦é¡§å®¢è¿½åŠ </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>ç·é¡§å®¢æ•°</h3>
                <div class="value" id="totalTenants">0</div>
            </div>
            <div class="stat-card">
                <h3>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–é¡§å®¢</h3>
                <div class="value" id="activeTenants">0</div>
            </div>
            <div class="stat-card">
                <h3>æœªå¯¾å¿œã‚¿ã‚¹ã‚¯</h3>
                <div class="value" id="pendingTasks">0</div>
            </div>
            <div class="stat-card">
                <h3>ä»Šæœˆã®ç·é€ä¿¡æ•°</h3>
                <div class="value" id="monthlySent">0</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('tenants')">é¡§å®¢ä¸€è¦§</button>
            <button class="tab" onclick="switchTab('tasks')">ã‚¿ã‚¹ã‚¯ç®¡ç†</button>
            <button class="tab" onclick="switchTab('reports')">ãƒ¬ãƒãƒ¼ãƒˆ</button>
            <button class="tab" onclick="switchTab('analytics')">CTRåˆ†æ</button>
        </div>

        <div id="tenants-tab" class="tab-content active">
            <div class="tenants-list" id="tenantsList">
                <div class="empty-state">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <div id="tasks-tab" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="showCreateTaskModal()">æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆ</button>
            </div>
            <div class="tasks-list" id="tasksList">
                <div class="empty-state">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <div id="reports-tab" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="showCreateReportModal()">æ–°è¦ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ</button>
            </div>
            <div class="reports-list" id="reportsList">
                <div class="empty-state">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <div id="analytics-tab" class="tab-content">
            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ -->
            <div class="analytics-filter-bar">
                <label>é¡§å®¢:</label>
                <select id="analyticsTenantFilter" onchange="renderAnalytics()">
                    <option value="">å…¨é¡§å®¢</option>
                </select>
                <label style="margin-left: 8px;">æœŸé–“:</label>
                <select id="analyticsPeriodFilter" onchange="renderAnalytics()">
                    <option value="7d">éå»7æ—¥</option>
                    <option value="30d" selected>éå»30æ—¥</option>
                    <option value="90d">éå»90æ—¥</option>
                </select>
            </div>

            <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
            <div class="analytics-stats-grid" id="analyticsOverview">
                <div class="analytics-stat-card">
                    <h3>å¹³å‡ CTR</h3>
                    <div class="value" id="statAvgCtr">â€”</div>
                    <div class="sub">å…¨é¡§å®¢ã®åŠ é‡å¹³å‡</div>
                </div>
                <div class="analytics-stat-card">
                    <h3>å¹³å‡é–‹å°ç‡</h3>
                    <div class="value" id="statAvgOpen">â€”</div>
                    <div class="sub">å…¨é¡§å®¢ã®åŠ é‡å¹³å‡</div>
                </div>
                <div class="analytics-stat-card">
                    <h3>ç·é…ä¿¡æ•°</h3>
                    <div class="value" id="statTotalSent">â€”</div>
                    <div class="sub">æœŸé–“å†…ã®åˆè¨ˆ</div>
                </div>
                <div class="analytics-stat-card">
                    <h3>ç·ã‚¯ãƒªãƒƒã‚¯æ•°</h3>
                    <div class="value" id="statTotalClicked">â€”</div>
                    <div class="sub">æœŸé–“å†…ã®åˆè¨ˆ</div>
                </div>
            </div>

            <!-- é€šçŸ¥åˆ¥ CTR ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="analytics-table-wrap">
                <h3>é€šçŸ¥åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
                <table class="ctr-table">
                    <thead>
                        <tr>
                            <th>é¡§å®¢</th>
                            <th>é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ«</th>
                            <th>é…ä¿¡æ•°</th>
                            <th>é–‹å°æ•°</th>
                            <th>ã‚¯ãƒªãƒƒã‚¯æ•°</th>
                            <th style="min-width:160px;">é–‹å°ç‡</th>
                            <th style="min-width:160px;">CTR</th>
                            <th>é…ä¿¡æ—¥</th>
                        </tr>
                    </thead>
                    <tbody id="analyticsTableBody">
                        <tr><td colspan="8" style="text-align:center;padding:40px;color:#aaa;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- é¡§å®¢ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="createTenantModal" class="modal">
        <div class="modal-content">
            <h2>æ–°è¦é¡§å®¢è¿½åŠ </h2>
            <form id="createTenantForm">
                <div class="form-group">
                    <label>é¡§å®¢å *</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>ãƒ—ãƒ©ãƒ³ *</label>
                    <select name="plan" required>
                        <option value="basic">Basic (Â¥10ä¸‡/æœˆ)</option>
                        <option value="pro">Pro (Â¥25ä¸‡/æœˆ)</option>
                        <option value="enterprise">Enterprise (Â¥50ä¸‡/æœˆ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æœˆé–“é€ä¿¡ä¸Šé™</label>
                    <input type="number" name="monthly_limit" value="10000">
                </div>
                <div class="form-group">
                    <label>å¥‘ç´„é–‹å§‹æ—¥</label>
                    <input type="date" name="contract_start_date">
                </div>
                <div class="form-group">
                    <label>å¥‘ç´„çµ‚äº†æ—¥ï¼ˆä»»æ„ï¼‰</label>
                    <input type="date" name="contract_end_date">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createTenantModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä½œæˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <h2>æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆ</h2>
            <form id="createTaskForm">
                <div class="form-group">
                    <label>é¡§å®¢ *</label>
                    <select name="tenant_id" id="taskTenantSelect" required></select>
                </div>
                <div class="form-group">
                    <label>ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ— *</label>
                    <select name="task_type" required>
                        <option value="notification_create">é€šçŸ¥ä½œæˆ</option>
                        <option value="step_sequence_create">ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡è¨­è¨ˆ</option>
                        <option value="segment_create">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä½œæˆ</option>
                        <option value="report_create">ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ</option>
                        <option value="optimization">æœ€é©åŒ–</option>
                        <option value="support">ã‚µãƒãƒ¼ãƒˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ã‚¿ã‚¤ãƒˆãƒ« *</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>èª¬æ˜</label>
                    <textarea name="description"></textarea>
                </div>
                <div class="form-group">
                    <label>å„ªå…ˆåº¦</label>
                    <select name="priority">
                        <option value="low">ä½</option>
                        <option value="normal" selected>é€šå¸¸</option>
                        <option value="high">é«˜</option>
                        <option value="urgent">ç·Šæ€¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æœŸé™</label>
                    <input type="date" name="due_date">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createTaskModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä½œæˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ãƒ¬ãƒãƒ¼ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="createReportModal" class="modal">
        <div class="modal-content">
            <h2>æ–°è¦ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ</h2>
            <form id="createReportForm">
                <div class="form-group">
                    <label>é¡§å®¢ *</label>
                    <select name="tenant_id" id="reportTenantSelect" required></select>
                </div>
                <div class="form-group">
                    <label>ãƒ¬ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ— *</label>
                    <select name="report_type" required>
                        <option value="weekly">é€±æ¬¡</option>
                        <option value="monthly" selected>æœˆæ¬¡</option>
                        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æœŸé–“é–‹å§‹æ—¥ *</label>
                    <input type="date" name="period_start" required>
                </div>
                <div class="form-group">
                    <label>æœŸé–“çµ‚äº†æ—¥ *</label>
                    <input type="date" name="period_end" required>
                </div>
                <div class="form-group">
                    <label>ã‚¿ã‚¤ãƒˆãƒ« *</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>ã‚µãƒãƒªãƒ¼</label>
                    <textarea name="summary"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createReportModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä½œæˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼ˆAPIæ•°åˆ¶é™ã®ãŸã‚ã€UIè¡¨ç¤ºã®ã¿ï¼‰
        const MOCK_MODE = true;
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã¯ä¸è¦ï¼ˆãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼‰
        const ADMIN_PASSWORD = 'mock';

        let tenants = [];
        let tasks = [];
        let reports = [];

        // CTRåˆ†æç”¨ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ãƒŠãƒ³ãƒˆåˆ¥ãƒ»é€šçŸ¥åˆ¥ï¼‰
        const analyticsNotifications = [
            { tenant_id: 1, tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­A', title: 'æ–°å•†å“ç™ºå£²ã®ãŠçŸ¥ã‚‰ã›', sent: 5200, opened: 1430, clicked: 546, sent_at: '2026-02-10' },
            { tenant_id: 1, tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­A', title: 'é€±æœ«é™å®šã‚»ãƒ¼ãƒ«', sent: 4800, opened: 1680, clicked: 672, sent_at: '2026-02-07' },
            { tenant_id: 1, tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­A', title: 'ãƒã‚¤ãƒ³ãƒˆ2å€ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³', sent: 5000, opened: 1250, clicked: 375, sent_at: '2026-02-01' },
            { tenant_id: 1, tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­A', title: 'ã‚¦ã‚£ãƒ³ã‚¿ãƒ¼ã‚»ãƒ¼ãƒ«é–‹å§‹', sent: 4900, opened: 1715, clicked: 588, sent_at: '2026-01-25' },
            { tenant_id: 2, tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­B', title: 'ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›', sent: 900, opened: 360, clicked: 72, sent_at: '2026-02-12' },
            { tenant_id: 2, tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­B', title: 'æ–°æ©Ÿèƒ½ãƒªãƒªãƒ¼ã‚¹', sent: 850, opened: 340, clicked: 119, sent_at: '2026-02-05' },
            { tenant_id: 2, tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­B', title: 'ä¼šå“¡é™å®šã‚¯ãƒ¼ãƒãƒ³', sent: 880, opened: 396, clicked: 158, sent_at: '2026-01-30' },
            { tenant_id: 3, tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­C', title: 'æ˜¥ã®å¤§æ„Ÿè¬ç¥­', sent: 28000, opened: 9800, clicked: 4200, sent_at: '2026-02-14' },
            { tenant_id: 3, tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­C', title: 'æœ¬æ—¥é™ã‚Šã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚»ãƒ¼ãƒ«', sent: 30000, opened: 12000, clicked: 5400, sent_at: '2026-02-08' },
            { tenant_id: 3, tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­C', title: 'ã‚¢ãƒ—ãƒªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå®Œäº†', sent: 25000, opened: 7500, clicked: 2250, sent_at: '2026-02-02' },
            { tenant_id: 3, tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­C', title: 'æ–°è¦ä¼šå“¡ç™»éŒ²ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³', sent: 27000, opened: 10800, clicked: 3510, sent_at: '2026-01-28' },
        ];

        async function loadData() {
            await Promise.all([
                loadTenants(),
                loadTasks(),
                loadReports(),
                loadStats()
            ]);
        }

        // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆUIè¡¨ç¤ºç”¨ï¼‰
        async function loadTenants() {
            // APIå‘¼ã³å‡ºã—ã‚’ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆï¼ˆAPIæ•°åˆ¶é™ã®ãŸã‚ï¼‰
            setTimeout(() => {
                tenants = [
                    {
                        id: 1,
                        name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­A',
                        plan: 'pro',
                        monthly_fee: 250000,
                        monthly_sent_count: 45000,
                        monthly_limit: 100000,
                        status: 'active',
                        stats: {
                            user_count: 1250,
                            notification_count: 45,
                            pending_task_count: 3
                        }
                    },
                    {
                        id: 2,
                        name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­B',
                        plan: 'basic',
                        monthly_fee: 100000,
                        monthly_sent_count: 8500,
                        monthly_limit: 10000,
                        status: 'active',
                        stats: {
                            user_count: 320,
                            notification_count: 12,
                            pending_task_count: 1
                        }
                    },
                    {
                        id: 3,
                        name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­C',
                        plan: 'enterprise',
                        monthly_fee: 500000,
                        monthly_sent_count: 250000,
                        monthly_limit: 999999999,
                        status: 'active',
                        stats: {
                            user_count: 5600,
                            notification_count: 128,
                            pending_task_count: 5
                        }
                    }
                ];
                renderTenants();
                // CTRåˆ†æã‚¿ãƒ–ã®é¡§å®¢ã‚»ãƒ¬ã‚¯ãƒˆã‚’æ›´æ–°ã—ã¦åˆæœŸæç”»
                const sel = document.getElementById('analyticsTenantFilter');
                sel.innerHTML = '<option value="">å…¨é¡§å®¢</option>' +
                    tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                renderAnalytics();
            }, 500);
        }

        async function loadTasks() {
            // APIå‘¼ã³å‡ºã—ã‚’ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆï¼ˆAPIæ•°åˆ¶é™ã®ãŸã‚ï¼‰
            setTimeout(() => {
                tasks = [
                    {
                        id: 1,
                        tenant_id: 1,
                        tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­A',
                        task_type: 'notification_create',
                        title: 'æ–°å•†å“ç™ºå£²é€šçŸ¥ã‚’ä½œæˆ',
                        description: 'æ¥é€±ç™ºå£²ã®æ–°å•†å“ã®é€šçŸ¥ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™',
                        status: 'pending',
                        priority: 'high',
                        due_date: '2026-02-15'
                    },
                    {
                        id: 2,
                        tenant_id: 2,
                        tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­B',
                        task_type: 'step_sequence_create',
                        title: 'ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®è¨­è¨ˆ',
                        description: 'æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡ã‚’è¨­è¨ˆ',
                        status: 'in_progress',
                        priority: 'normal',
                        due_date: '2026-02-20'
                    },
                    {
                        id: 3,
                        tenant_id: 1,
                        tenant_name: 'ã‚µãƒ³ãƒ—ãƒ«ä¼æ¥­A',
                        task_type: 'report_create',
                        title: '1æœˆã®æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ',
                        description: '1æœˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ',
                        status: 'completed',
                        priority: 'normal',
                        due_date: '2026-02-05',
                        completed_at: '2026-02-05T10:00:00Z'
                    }
                ];
                renderTasks();
            }, 500);
        }

        async function loadReports() {
            // APIå‘¼ã³å‡ºã—ã‚’ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆï¼ˆAPIæ•°åˆ¶é™ã®ãŸã‚ï¼‰
            setTimeout(() => {
                reports = [
                    {
                        id: 1,
                        tenant_id: 1,
                        report_type: 'monthly',
                        period_start: '2026-01-01',
                        period_end: '2026-01-31',
                        title: '2026å¹´1æœˆ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ',
                        summary: '1æœˆã®é€šçŸ¥é…ä¿¡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚'
                    },
                    {
                        id: 2,
                        tenant_id: 2,
                        report_type: 'monthly',
                        period_start: '2026-01-01',
                        period_end: '2026-01-31',
                        title: '2026å¹´1æœˆ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ',
                        summary: '1æœˆã®é€šçŸ¥é…ä¿¡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚'
                    }
                ];
                renderReports();
            }, 500);
        }

        async function loadStats() {
            const totalTenants = tenants.length;
            const activeTenants = tenants.filter(t => t.status === 'active').length;
            const pendingTasks = tasks.filter(t => ['pending', 'in_progress'].includes(t.status)).length;
            const monthlySent = tenants.reduce((sum, t) => sum + (t.monthly_sent_count || 0), 0);

            document.getElementById('totalTenants').textContent = totalTenants;
            document.getElementById('activeTenants').textContent = activeTenants;
            document.getElementById('pendingTasks').textContent = pendingTasks;
            document.getElementById('monthlySent').textContent = monthlySent.toLocaleString();
        }

        function periodDays(period) {
            if (period === '7d')  return 7;
            if (period === '90d') return 90;
            return 30;
        }

        function renderAnalytics() {
            const tenantId  = parseInt(document.getElementById('analyticsTenantFilter').value) || null;
            const period    = document.getElementById('analyticsPeriodFilter').value;
            const cutoff    = new Date();
            cutoff.setDate(cutoff.getDate() - periodDays(period));

            // æœŸé–“ãƒ»ãƒ†ãƒŠãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            let rows = analyticsNotifications.filter(n => {
                const d = new Date(n.sent_at);
                if (d < cutoff) return false;
                if (tenantId && n.tenant_id !== tenantId) return false;
                return true;
            });

            // ã‚µãƒãƒªãƒ¼è¨ˆç®—
            const totalSent    = rows.reduce((s, n) => s + n.sent, 0);
            const totalOpened  = rows.reduce((s, n) => s + n.opened, 0);
            const totalClicked = rows.reduce((s, n) => s + n.clicked, 0);
            const avgOpen = totalSent > 0 ? (totalOpened  / totalSent * 100).toFixed(1) : '0.0';
            const avgCtr  = totalSent > 0 ? (totalClicked / totalSent * 100).toFixed(1) : '0.0';

            document.getElementById('statAvgCtr').textContent    = avgCtr + '%';
            document.getElementById('statAvgOpen').textContent   = avgOpen + '%';
            document.getElementById('statTotalSent').textContent = totalSent.toLocaleString();
            document.getElementById('statTotalClicked').textContent = totalClicked.toLocaleString();

            // è‰²åˆ†ã‘ã‚¯ãƒ©ã‚¹
            function ctrClass(val) {
                if (val >= 10) return 'ctr-good';
                if (val >= 5)  return 'ctr-mid';
                return 'ctr-low';
            }

            // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
            const tbody = document.getElementById('analyticsTableBody');
            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#aaa;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            const maxSent = Math.max(...rows.map(n => n.sent));

            tbody.innerHTML = rows.map(n => {
                const openRate = n.sent > 0 ? (n.opened  / n.sent * 100).toFixed(1) : '0.0';
                const ctr      = n.sent > 0 ? (n.clicked / n.sent * 100).toFixed(1) : '0.0';
                const openPct  = n.sent > 0 ? (n.opened  / n.sent * 100) : 0;
                const ctrPct   = n.sent > 0 ? (n.clicked / n.sent * 100) : 0;
                return `
                <tr>
                    <td><span class="tenant-badge">${n.tenant_name}</span></td>
                    <td>${n.title}</td>
                    <td>${n.sent.toLocaleString()}</td>
                    <td>${n.opened.toLocaleString()}</td>
                    <td>${n.clicked.toLocaleString()}</td>
                    <td>
                        <div class="bar-wrap">
                            <div class="bar-bg"><div class="bar-fill open-color" style="width:${Math.min(openPct * 2, 100)}%"></div></div>
                            <span style="min-width:42px;text-align:right">${openRate}%</span>
                        </div>
                    </td>
                    <td>
                        <div class="bar-wrap">
                            <div class="bar-bg"><div class="bar-fill ctr-color" style="width:${Math.min(ctrPct * 5, 100)}%"></div></div>
                            <span class="${ctrClass(parseFloat(ctr))}" style="min-width:42px;text-align:right;font-weight:600">${ctr}%</span>
                        </div>
                    </td>
                    <td style="color:#888">${n.sent_at}</td>
                </tr>`;
            }).join('');
        }

        function renderTenants() {
            const container = document.getElementById('tenantsList');
            if (tenants.length === 0) {
                container.innerHTML = '<div class="empty-state">é¡§å®¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = tenants.map(tenant => `
                <div class="list-item">
                    <div class="item-info">
                        <h4>${tenant.name}</h4>
                        <p>ãƒ—ãƒ©ãƒ³: ${tenant.plan} | æœˆé¡: Â¥${(tenant.monthly_fee || 0).toLocaleString()}</p>
                        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${tenant.stats?.user_count || 0} | é€šçŸ¥æ•°: ${tenant.stats?.notification_count || 0} | æœªå¯¾å¿œã‚¿ã‚¹ã‚¯: ${tenant.stats?.pending_task_count || 0}</p>
                        <p>é€ä¿¡æ•°: ${tenant.monthly_sent_count || 0} / ${tenant.monthly_limit || 0}</p>
                    </div>
                    <div class="item-actions">
                        <span class="status-badge status-${tenant.status}">${tenant.status}</span>
                        <button class="btn btn-primary" onclick="viewTenant(${tenant.id})">è©³ç´°</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTasks() {
            const container = document.getElementById('tasksList');
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="list-item">
                    <div class="item-info">
                        <h4>${task.title}</h4>
                        <p>é¡§å®¢: ${task.tenant_name} | ã‚¿ã‚¤ãƒ—: ${task.task_type}</p>
                        <p>${task.description || ''}</p>
                        ${task.due_date ? `<p>æœŸé™: ${task.due_date}</p>` : ''}
                    </div>
                    <div class="item-actions">
                        <span class="status-badge status-${task.status}">${task.status}</span>
                        ${task.status !== 'completed' ? `<button class="btn btn-success" onclick="completeTask(${task.id})">å®Œäº†</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderReports() {
            const container = document.getElementById('reportsList');
            if (reports.length === 0) {
                container.innerHTML = '<div class="empty-state">ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = reports.map(report => `
                <div class="list-item">
                    <div class="item-info">
                        <h4>${report.title}</h4>
                        <p>æœŸé–“: ${report.period_start} ï½ ${report.period_end}</p>
                        <p>${report.summary || ''}</p>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-primary" onclick="viewReport(${report.id})">è¡¨ç¤º</button>
                    </div>
                </div>
            `).join('');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function showCreateTenantModal() {
            document.getElementById('createTenantModal').classList.add('active');
            document.getElementById('createTenantForm').reset();
        }

        function showCreateTaskModal() {
            // é¡§å®¢é¸æŠè‚¢ã‚’è¨­å®š
            const select = document.getElementById('taskTenantSelect');
            select.innerHTML = tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            
            document.getElementById('createTaskModal').classList.add('active');
            document.getElementById('createTaskForm').reset();
        }

        function showCreateReportModal() {
            // é¡§å®¢é¸æŠè‚¢ã‚’è¨­å®š
            const select = document.getElementById('reportTenantSelect');
            select.innerHTML = tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            
            document.getElementById('createReportModal').classList.add('active');
            document.getElementById('createReportForm').reset();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã§å‹•ä½œï¼ˆAPIæ•°åˆ¶é™ã®ãŸã‚ï¼‰
        document.getElementById('createTenantForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            // ãƒ¢ãƒƒã‚¯: æ–°ã—ã„é¡§å®¢ã‚’è¿½åŠ 
            const newTenant = {
                id: tenants.length + 1,
                name: data.name,
                plan: data.plan,
                monthly_fee: data.plan === 'basic' ? 100000 : data.plan === 'pro' ? 250000 : 500000,
                monthly_sent_count: 0,
                monthly_limit: parseInt(data.monthly_limit) || 10000,
                status: 'active',
                stats: { user_count: 0, notification_count: 0, pending_task_count: 0 }
            };
            tenants.push(newTenant);
            alert('é¡§å®¢ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼‰');
            closeModal('createTenantModal');
            await loadData();
        });

        document.getElementById('createTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            // ãƒ¢ãƒƒã‚¯: æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
            const tenant = tenants.find(t => t.id == data.tenant_id);
            const newTask = {
                id: tasks.length + 1,
                tenant_id: parseInt(data.tenant_id),
                tenant_name: tenant ? tenant.name : 'ä¸æ˜',
                task_type: data.task_type,
                title: data.title,
                description: data.description || '',
                status: 'pending',
                priority: data.priority || 'normal',
                due_date: data.due_date || null
            };
            tasks.push(newTask);
            alert('ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼‰');
            closeModal('createTaskModal');
            await loadData();
        });

        document.getElementById('createReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            // ãƒ¢ãƒƒã‚¯: æ–°ã—ã„ãƒ¬ãƒãƒ¼ãƒˆã‚’è¿½åŠ 
            const newReport = {
                id: reports.length + 1,
                tenant_id: parseInt(data.tenant_id),
                report_type: data.report_type,
                period_start: data.period_start,
                period_end: data.period_end,
                title: data.title,
                summary: data.summary || ''
            };
            reports.push(newReport);
            alert('ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼‰');
            closeModal('createReportModal');
            await loadData();
        });

        async function completeTask(taskId) {
            if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ')) return;

            // ãƒ¢ãƒƒã‚¯: ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã«ã™ã‚‹
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'completed';
                task.completed_at = new Date().toISOString();
                await loadData();
            }
        }

        function viewTenant(tenantId) {
            const tenant = tenants.find(t => t.id === tenantId);
            if (tenant) {
                alert(`é¡§å®¢è©³ç´°: ${tenant.name}\nãƒ—ãƒ©ãƒ³: ${tenant.plan}\næœˆé¡: Â¥${tenant.monthly_fee.toLocaleString()}\nãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${tenant.stats?.user_count || 0}\né€šçŸ¥æ•°: ${tenant.stats?.notification_count || 0}\næœªå¯¾å¿œã‚¿ã‚¹ã‚¯: ${tenant.stats?.pending_task_count || 0}`);
            }
        }

        function viewReport(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (report) {
                alert(`ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°: ${report.title}\næœŸé–“: ${report.period_start} ï½ ${report.period_end}\n${report.summary || ''}`);
            }
        }

        // åˆæœŸèª­ã¿è¾¼ã¿
        async function onAdminReady(user) {
            await loadData();
        }
    </script>
    </div><!-- end admin-page -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="/admin/admin.js"></script>
</body>
</html>
