# 08. 開発タスク・スケジュール

## 概要

MVP完成まで **2日間** で開発する。
Vercel + Node.js + Supabase + FCM の構成。

---

## DONE条件（再掲）

- [ ] iPhone実機で通知が届く
- [ ] 時間指定で正しく送信される
- [ ] 管理画面から5分以内に操作説明が終わる
- [ ] 他人に触らせて詰まらない

---

## Day 1: 基盤構築 + フロントエンド + API

### Phase 1: 環境セットアップ（1〜2時間）

| # | タスク | 詳細 | 完了条件 |
|---|---|---|---|
| 1-1 | Firebaseプロジェクト作成 | Console で新規作成 | プロジェクトが表示される |
| 1-2 | Webアプリ登録 | Firebase Console | firebaseConfig 取得済み |
| 1-3 | VAPID Key取得 | Cloud Messaging 設定 | キーをメモ済み |
| 1-4 | サービスアカウント情報取得 | 秘密鍵の生成 | project_id, client_email, private_key メモ済み |
| 1-5 | Supabaseプロジェクト作成 | supabase.com | プロジェクトURL取得済み |
| 1-6 | Supabaseテーブル作成 | SQL Editor で実行 | users, notifications テーブル存在 |
| 1-7 | Supabase RLS設定 | SQL Editor で実行 | ポリシー設定済み |
| 1-8 | プロジェクト初期化 | `npm init -y && npm install` | package.json + node_modules |
| 1-9 | GitHubリポジトリ作成 | git init & push | GitHubに反映 |
| 1-10 | Vercelプロジェクト作成 | Vercel にインポート | デプロイURL取得 |
| 1-11 | Vercel環境変数設定 | ダッシュボードで設定 | 全環境変数設定済み |

### Phase 2: PWAフロントエンド（2〜3時間）

| # | タスク | 詳細 | 完了条件 |
|---|---|---|---|
| 2-1 | manifest.json 作成 | `public/manifest.json` | DevToolsで認識 |
| 2-2 | アイコン作成 | 192x192, 512x512 | `public/icons/` に配置 |
| 2-3 | index.html 作成 | LP画面（通知許可取得） | ブラウザで表示確認 |
| 2-4 | thanks.html 作成 | 登録完了画面 | ブラウザで表示確認 |
| 2-5 | style.css 作成 | レスポンシブCSS | モバイル表示確認 |
| 2-6 | app.js 作成 | Firebase初期化 + トークン取得 | consoleでトークン確認 |
| 2-7 | sw.js 作成 | PWA Service Worker | DevToolsで登録確認 |
| 2-8 | firebase-messaging-sw.js 作成 | FCMバックグラウンド受信 | DevToolsで登録確認 |

### Phase 3: バックエンドAPI（1〜2時間）

| # | タスク | 詳細 | 完了条件 |
|---|---|---|---|
| 3-1 | lib/supabase.js 作成 | Supabaseクライアント | import成功 |
| 3-2 | lib/firebase-admin.js 作成 | Firebase Admin初期化 | import成功 |
| 3-3 | lib/auth.js 作成 | 管理者認証ミドルウェア | 認証テスト通過 |
| 3-4 | api/register-token.js 作成 | トークン登録API | curlでPOST成功 |
| 3-5 | vercel.json 作成 | ルーティング + cron設定 | `vercel dev` で動作確認 |
| 3-6 | git push → Vercelデプロイ | 自動デプロイ | 本番URLでアクセス確認 |
| 3-7 | 実機テスト（トークン登録） | Safari/Chromeから | Supabaseにトークン保存確認 |

### Day 1 完了チェック
- [ ] PWAがホーム画面に追加できる
- [ ] 通知許可ダイアログが表示される
- [ ] FCMトークンがSupabaseに保存される
- [ ] `vercel dev` でローカル開発できる
- [ ] 本番URLにデプロイされている

---

## Day 2: 送信機能 + 管理画面 + テスト

### Phase 4: 通知送信機能（1〜2時間）

| # | タスク | 詳細 | 完了条件 |
|---|---|---|---|
| 4-1 | api/send-notification.js 作成 | テスト送信API | curl で送信→通知受信 |
| 4-2 | api/cron/send-scheduled.js 作成 | 予約送信API | 手動GETで動作確認 |
| 4-3 | api/notifications/create.js 作成 | 通知作成API | curl で通知作成成功 |
| 4-4 | api/notifications/list.js 作成 | 通知一覧API | curl で一覧取得成功 |
| 4-5 | api/stats.js 作成 | ユーザー数取得API | curl でカウント取得 |
| 4-6 | FCM送信テスト | 1デバイスに送信 | 実機で通知表示確認 |

### Phase 5: 管理画面（2〜3時間）

| # | タスク | 詳細 | 完了条件 |
|---|---|---|---|
| 5-1 | admin/index.html 作成 | ログイン + 通知一覧 | 管理画面表示確認 |
| 5-2 | admin/create.html 作成 | 通知作成フォーム | 通知がDBに保存される |
| 5-3 | admin/admin.js 作成 | API呼び出し + 認証ロジック | 全操作が動作する |
| 5-4 | admin/admin.css 作成 | 管理画面CSS | 見た目OK |
| 5-5 | テスト送信ボタン実装 | admin内に実装 | ボタンクリックで通知受信 |

### Phase 6: 統合テスト（1〜2時間）

| # | タスク | 詳細 | 完了条件 |
|---|---|---|---|
| 6-1 | Vercel Cron設定確認 | vercel.json のcron | Vercelダッシュボードで確認 |
| 6-2 | 予約送信テスト | 未来の通知を作成 → cron待ち | 自動送信されて通知受信 |
| 6-3 | iPhone実機テスト | Safari → PWA追加 → 通知許可 → 受信 | 全フロー通過 |
| 6-4 | Android実機テスト | Chrome → 通知許可 → 受信 | 全フロー通過 |
| 6-5 | 管理画面操作テスト | 5分以内に操作説明 | 他人が詰まらない |

### Day 2 完了チェック
- [ ] 管理画面から通知作成できる
- [ ] テスト送信で通知が届く
- [ ] 予約送信がcronで自動実行される
- [ ] iPhone実機で全フロー動作
- [ ] Android実機で全フロー動作

---

## タスク依存関係図

```
Phase 1 (環境セットアップ)
    │
    ├──→ Phase 2 (フロントエンド)
    │        │
    │        └──→ Phase 3 (API)
    │                 │
    │                 ├──→ Phase 4 (送信機能)
    │                 │        │
    │                 │        └──→ Phase 6 (テスト)
    │                 │                      ▲
    │                 └──→ Phase 5 (管理画面) ┘
    │
    └── 並行作業可能: Phase 2 + Phase 5（画面実装）
```

---

## Vercel プラン選択ガイド

### Hobbyプラン（無料）で始める場合

| 制約 | 影響 | 対策 |
|---|---|---|
| Cron: 1日1回 | 通知送信が最大24時間遅延 | 手動テスト送信で補完 / 重要通知は手動送信 |
| Function実行: 10秒 | 500人以上で失敗リスク | 初期は数百人規模なので問題なし |
| 帯域: 100GB/月 | 十分 | - |

### Proプラン（$20/月）に移行するタイミング

- ユーザーが500人を超えた
- 5分間隔のcronが必要になった
- 収益が出始めた

---

## リスク・注意点

| リスク | 影響 | 対策 |
|---|---|---|
| iOS PWAで通知が動かない | MVP不成立 | 早期に実機テスト（Day1で確認） |
| Vercel Hobbyのcron制限 | 送信遅延 | 手動テスト送信で代替 |
| firebase-admin 初期化エラー | 送信不可 | 環境変数（特にprivate_key）を確認 |
| CORS設定ミス | トークン登録失敗 | DevTools Network タブで確認 |
| Serverless タイムアウト | 大量送信失敗 | 初期は少人数なのでOK |

---

## デプロイフロー

```
[ローカル開発]
    │
    ├── vercel dev で動作確認
    │
    ▼
[git add → git commit → git push]
    │
    ▼
[Vercel 自動デプロイ]
    │
    ├── Preview URL で確認（PRの場合）
    │
    ▼
[本番URL に反映]
    │
    └── https://narukami-mvp.vercel.app（例）
```

> FTPアップロード不要。`git push` だけで本番反映される。

---

## MVP後のロードマップ（参考・実装しない）

| Phase | 機能 | 優先度 |
|---|---|---|
| Phase 2 | 無効トークン自動削除 | 高 |
| Phase 2 | 送信ログ・履歴画面 | 中 |
| Phase 2 | Proプラン移行（cron 5分間隔） | 高 |
| Phase 3 | 個別配信（セグメント） | 中 |
| Phase 3 | 開封率トラッキング | 中 |
| Phase 4 | 管理者ログイン認証（Supabase Auth） | 低 |
| Phase 4 | マルチテナント | 低 |
| Phase 5 | ノーコード編集UI | 低 |
