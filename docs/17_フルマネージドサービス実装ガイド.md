# 17. フルマネージドサービス実装ガイド

## 概要

高単価フルマネージドサービスとして5社を管理するための実装が完了しました。API数制限（Vercel Hobbyプラン: 12個）を考慮し、既存APIを拡張してマルチテナント対応を実現しています。

---

## 実装内容

### 1. データベーススキーマ

#### 新規テーブル

- **`tenants`**: 顧客（テナント）管理
  - `id`, `name`, `plan` (basic/pro/enterprise)
  - `monthly_sent_count`, `monthly_limit`
  - `status` (active/suspended/cancelled)
  - `monthly_fee`, `contract_start_date`, `contract_end_date`

- **`customer_users`**: 顧客の担当者（ログイン可能）
  - `tenant_id`, `email`, `name`, `role` (admin/viewer)
  - `supabase_auth_user_id` (将来の認証統合用)

- **`tasks`**: 作業管理
  - `tenant_id`, `task_type`, `title`, `description`
  - `status` (pending/in_progress/completed/cancelled)
  - `priority` (low/normal/high/urgent), `due_date`

- **`reports`**: レポート管理
  - `tenant_id`, `report_type` (weekly/monthly/custom)
  - `period_start`, `period_end`, `title`, `summary`
  - `data` (JSONB形式のレポートデータ)

#### 既存テーブルへの拡張

以下のテーブルに `tenant_id` カラムを追加：

- `users`
- `notifications`
- `step_sequences`
- `user_segments`
- `notification_events`
- `notification_stats`

**マイグレーション実行**:
```sql
-- supabase_managed_service_setup.sql を実行
```

---

### 2. API実装（既存APIを拡張）

#### 新規API（3個）

1. **`/api/tenants`** - テナント管理
   - `?action=list` - 顧客一覧取得（統計情報付き）
   - `?action=create` - 新規顧客追加
   - `?action=update` - 顧客情報更新
   - `?action=get&id=xxx` - 顧客詳細取得

2. **`/api/tasks`** - タスク管理
   - `?action=list&tenant_id=xxx` - タスク一覧（テナント別）
   - `?action=create` - タスク作成
   - `?action=update` - タスク更新
   - `?action=complete` - タスク完了

3. **`/api/reports`** - レポート管理
   - `?action=list&tenant_id=xxx` - レポート一覧
   - `?action=create` - レポート作成（自動集計）
   - `?action=get&id=xxx` - レポート詳細

#### 既存APIの拡張（tenant_id対応）

以下のAPIに `tenant_id` クエリパラメータを追加し、フィルタリング可能に：

- **`/api/notifications/list`**: `?tenant_id=xxx`
- **`/api/notifications/create`**: リクエストボディに `tenant_id` を追加
- **`/api/analytics`**: `?tenant_id=xxx` で全エンドポイント対応
- **`/api/segments`**: `?tenant_id=xxx` で全エンドポイント対応
- **`/api/cron/send-scheduled`**: 通知送信時に `tenant_id` でフィルタリング
- **`/api/register-token`**: ユーザー登録時に `tenant_id` を設定可能

---

### 3. 管理画面

#### `/admin/managed.html` - フルマネージド管理画面

**機能**:
- 顧客一覧表示（統計情報付き）
- タスク管理（作成・完了）
- レポート作成・一覧
- ダッシュボード（総顧客数、アクティブ顧客、未対応タスク、月間送信数）

**UI構成**:
- タブ切り替え（顧客一覧 / タスク管理 / レポート）
- モーダルフォーム（顧客追加、タスク作成、レポート作成）
- 統計カード表示

---

## 使用方法

### 1. データベースマイグレーション

```bash
# Supabase SQL Editorで実行
# supabase_managed_service_setup.sql
```

### 2. 環境変数

既存の環境変数を使用（変更不要）:
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `ADMIN_PASSWORD`

### 3. 管理画面へのアクセス

```
https://your-domain.com/admin/managed.html
```

管理者パスワードを入力してアクセス。

### 4. 顧客追加

1. 「新規顧客追加」ボタンをクリック
2. 顧客名、プラン（Basic/Pro/Enterprise）を選択
3. 月間送信上限、契約期間を設定
4. 作成

### 5. タスク管理

1. 「タスク管理」タブを開く
2. 「新規タスク作成」ボタンをクリック
3. 顧客、タスクタイプ、タイトル、優先度、期限を設定
4. 作成後、「完了」ボタンでタスクを完了

### 6. レポート作成

1. 「レポート」タブを開く
2. 「新規レポート作成」ボタンをクリック
3. 顧客、レポートタイプ、期間を設定
4. 作成（自動で通知統計を集計）

---

## API使用例

### 顧客一覧取得

```javascript
const res = await fetch('/api/tenants?action=list', {
    headers: {
        'Authorization': `Bearer ${ADMIN_PASSWORD}`
    }
});
const result = await res.json();
console.log(result.data); // 顧客一覧（統計情報付き）
```

### テナント別通知一覧

```javascript
const res = await fetch('/api/notifications/list?tenant_id=1', {
    headers: {
        'Authorization': `Bearer ${ADMIN_PASSWORD}`
    }
});
```

### テナント別アナリティクス

```javascript
const res = await fetch('/api/analytics?type=overview&tenant_id=1', {
    headers: {
        'Authorization': `Bearer ${ADMIN_PASSWORD}`
    }
});
```

### タスク作成

```javascript
const res = await fetch('/api/tasks?action=create', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ADMIN_PASSWORD}`
    },
    body: JSON.stringify({
        tenant_id: 1,
        task_type: 'notification_create',
        title: '新商品通知作成',
        description: '新商品発売の通知を作成',
        priority: 'high',
        due_date: '2026-02-15'
    })
});
```

---

## 制約事項

### API数制限

- Vercel Hobbyプラン: 最大12個のServerless Functions
- 既存APIを拡張して使用（新規APIは3個のみ追加）
- 統合API（`/api/analytics`, `/api/segments`, `/api/tasks`等）を使用

### 認証

- 現在: Bearer Token認証（`ADMIN_PASSWORD`）
- 将来: Supabase Auth統合（`customer_users`テーブルと連携）

### マルチテナント分離

- `tenant_id` によるデータ分離
- RLS（Row Level Security）は未実装（サービス提供者のみアクセス）
- 顧客向けログイン機能は未実装（将来実装予定）

---

## 今後の拡張

### Phase 2: 顧客向けログイン

- Supabase Auth統合
- 顧客専用ダッシュボード（`/admin/customer-dashboard.html`）
- RLS設定でデータ分離

### Phase 3: 自動レポート配信

- 月次レポートの自動生成・メール送信
- PDFエクスポート機能

### Phase 4: 請求管理

- 月額料金の自動計算
- 請求書生成・送信

### Phase 5: パフォーマンス監視

- 送信上限の自動アラート
- パフォーマンス低下の通知

---

## トラブルシューティング

### データが表示されない

- `tenant_id` が正しく設定されているか確認
- データベースマイグレーションが完了しているか確認

### APIエラー

- 管理者パスワードが正しいか確認
- `tenant_id` が存在するか確認

### レポートが作成されない

- 指定期間内に通知が送信されているか確認
- `notification_stats` テーブルにデータがあるか確認

---

## まとめ

フルマネージドサービスとして5社を管理するための基本機能が実装されました。API数制限を考慮し、既存APIを拡張してマルチテナント対応を実現しています。

**次のステップ**:
1. データベースマイグレーション実行
2. テスト顧客を追加
3. タスク・レポート機能をテスト
4. 顧客向けログイン機能の実装（Phase 2）
