# 09. 管理画面強化 要件定義書

## 概要

現状の管理画面はMVP最低限の機能（通知作成・一覧表示・ユーザー数表示）に留まっている。
本ドキュメントでは、管理画面を「運用で最大限使える」レベルに引き上げるための要件を定義する。

### 現状の課題

| # | 課題 | 影響 |
|---|---|---|
| 1 | 通知の効果測定ができない | 改善PDCAが回せない |
| 2 | 全ユーザーへの一斉送信しかできない | 不要な通知によるオプトアウト増加 |
| 3 | ユーザーの行動データが取れない | ターゲティング不可 |
| 4 | ダッシュボードに可視化がない | 現状把握に時間がかかる |
| 5 | 通知の編集・削除ができない | 誤作成時のリカバリ不可 |
| 6 | ステップ配信の効果が見えない | シーケンス最適化不可 |

---

## 機能一覧（優先度順）

| # | 機能カテゴリ | 優先度 | 概要 |
|---|---|---|---|
| F1 | ダッシュボード強化 | P0（必須） | KPIサマリ・グラフ表示 |
| F2 | 通知効果測定（CTR・開封率） | P0（必須） | 通知ごとのパフォーマンス計測 |
| F3 | フィルタリング送信 | P0（必須） | セグメント別の通知配信 |
| F4 | 通知管理の強化 | P1（重要） | 編集・削除・複製・検索 |
| F5 | ユーザー管理画面 | P1（重要） | ユーザー一覧・詳細・セグメント管理 |
| F6 | ステップ配信分析 | P1（重要） | ファネル分析・離脱ポイント可視化 |
| F7 | A/Bテスト機能 | P2（あると良い） | 通知文面のテスト配信 |
| F8 | エクスポート機能 | P2（あると良い） | CSV/JSONでのデータ出力 |
| F9 | 通知テンプレート | P2（あると良い） | よく使う文面の保存・再利用 |

---

## F1. ダッシュボード強化

### 目的
管理画面トップに主要KPIをグラフ付きで一覧表示し、運用状況を瞬時に把握可能にする。

### F1-1. KPIサマリカード

画面上部にカード形式で主要指標を表示する。

| # | KPI | 説明 | データソース |
|---|---|---|---|
| 1 | 総ユーザー数 | 登録済みユーザーの総数 | `users` テーブルCOUNT |
| 2 | 今日の新規登録 | 本日登録されたユーザー数 | `users.created_at` が今日 |
| 3 | 今週の新規登録 | 今週登録されたユーザー数 | `users.created_at` が今週 |
| 4 | アクティブ購読者数 | 有効なサブスクリプションを持つユーザー数 | 無効トークンを除外した数 |
| 5 | 総通知送信数 | これまでに送信した通知の総数 | `notifications` WHERE `sent = true` |
| 6 | 平均開封率 | 全通知の平均開封率 | `notification_events` 集計 |
| 7 | 平均CTR | 全通知の平均クリック率 | `notification_events` 集計 |
| 8 | 直近の解除率 | 過去30日間の通知許可解除率 | 無効化トークン数 / 総ユーザー数 |

#### ワイヤーフレーム

```
┌──────────────────────────────────────────────────────┐
│  📊 ダッシュボード                         [ログアウト]  │
├──────────────────────────────────────────────────────┤
│                                                      │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐│
│  │ 👤 ユーザー │ │ 📈 新規(今週)│ │ ✉️ 開封率  │ │ 🖱 CTR   ││
│  │   1,234    │ │    +56     │ │  68.5%   │ │  12.3%   ││
│  │  ▲ +3.2%  │ │  ▲ +12%   │ │  ▼ -2.1% │ │  ▲ +0.8% ││
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘│
│                                                      │
└──────────────────────────────────────────────────────┘
```

各カードには前週比の増減率（▲ / ▼）を表示する。

### F1-2. グラフ表示

ダッシュボードに以下のグラフを表示する。ライブラリは **Chart.js**（CDN読み込み）を使用。

| # | グラフ名 | 種類 | 表示データ | 期間切替 |
|---|---|---|---|---|
| 1 | ユーザー推移 | 折れ線グラフ | 日別の累計ユーザー数・新規登録数 | 7日/30日/90日 |
| 2 | 通知パフォーマンス | 棒グラフ+折れ線 | 通知ごとの送信数・開封数・クリック数 | 直近10件/30件 |
| 3 | 開封率・CTR推移 | 折れ線グラフ | 通知ごとの開封率・CTR | 7日/30日/90日 |
| 4 | 時間帯別エンゲージメント | ヒートマップ | 曜日×時間帯の開封・クリック分布 | 30日/90日 |
| 5 | ユーザー登録チャネル | 円グラフ | デバイスタイプ・ブラウザ別の登録割合 | 全期間 |

#### ワイヤーフレーム

```
┌──────────────────────────────────────────────────────┐
│  📈 ユーザー推移              [7日] [30日] [90日]      │
│  ┌────────────────────────────────────────────────┐  │
│  │          ╱╲                                     │  │
│  │  ───────╱──╲────╱╲───────────                  │  │
│  │        ╱    ╲──╱  ╲         ╲──                │  │
│  │  ─────╱──────────────────────────              │  │
│  │  2/1  2/2  2/3  2/4  2/5  2/6  2/7            │  │
│  └────────────────────────────────────────────────┘  │
│  ── 累計ユーザー数  ── 新規登録数                       │
│                                                      │
├──────────────────────────────────────────────────────┤
│  📊 通知パフォーマンス（直近10件）                       │
│  ┌────────────────────────────────────────────────┐  │
│  │  ██  ██  ██  ██  ██  ██  ██  ██  ██  ██       │  │
│  │  ▓▓  ▓▓  ▓▓  ▓▓  ▓▓  ▓▓  ▓▓  ▓▓  ▓▓  ▓▓       │  │
│  │  ░░  ░░  ░░  ░░  ░░  ░░  ░░  ░░  ░░  ░░       │  │
│  └────────────────────────────────────────────────┘  │
│  ██ 送信数  ▓▓ 開封数  ░░ クリック数                    │
└──────────────────────────────────────────────────────┘
```

### F1-3. 最近のアクティビティログ

ダッシュボードに直近のイベントをタイムラインで表示する。

| イベント種類 | 表示例 |
|---|---|
| 通知送信完了 | `[2/8 14:00] 「週末セール」を 1,234人に送信しました（成功: 1,220 / 失敗: 14）` |
| 新規ユーザー登録 | `[2/8 13:45] 新規ユーザーが登録しました（本日 +12人）` |
| ステップ配信完了 | `[2/8 12:00] ステップ「ウェルカムシーケンス」Step2 を 45人に送信` |
| 通知予約作成 | `[2/8 11:30] 通知「新商品のお知らせ」を 2/10 09:00 に予約しました` |
| エラー発生 | `[2/8 10:00] ⚠️ 14件の無効トークンを検出・削除しました` |

---

## F2. 通知効果測定（CTR・開封率）

### 目的
通知ごとに開封率・CTR（クリックスルー率）を計測し、通知文面やタイミングの最適化を可能にする。

### F2-1. トラッキングの仕組み

#### 定義

| 指標 | 定義 | 計算式 |
|---|---|---|
| **配信成功率** | Web Pushの送信成功率 | 成功送信数 / 総送信対象数 × 100 |
| **開封率（Open Rate）** | 通知を表示したユーザーの割合 | 通知表示イベント数 / 成功送信数 × 100 |
| **CTR（Click-Through Rate）** | 通知をクリックしたユーザーの割合 | クリックイベント数 / 成功送信数 × 100 |
| **CVR（Conversion Rate）** | クリック後にコンバージョンした割合 | （Phase3で検討） |

#### トラッキングフロー

```
[通知送信]
    │
    ├── 送信成功 → notification_logs に記録
    │
    ▼
[ユーザーのデバイスに通知表示]
    │
    ├── Service Worker: push イベント発火
    │   └── POST /api/track/open（notification_id, user_id）
    │
    ▼
[ユーザーが通知をクリック]
    │
    ├── Service Worker: notificationclick イベント発火
    │   └── POST /api/track/click（notification_id, user_id）
    │
    ▼
[遷移先ページ表示]
```

### F2-2. 新規テーブル: `notification_events`

| カラム名 | 型 | 制約 | 説明 |
|---|---|---|---|
| `id` | `BIGSERIAL` | PRIMARY KEY | 自動採番ID |
| `notification_id` | `BIGINT` | NOT NULL, FK | 対象通知ID |
| `notification_type` | `VARCHAR(20)` | NOT NULL | `scheduled` / `step` / `immediate` |
| `user_id` | `BIGINT` | FK (nullable) | 対象ユーザーID |
| `event_type` | `VARCHAR(20)` | NOT NULL | `sent` / `delivered` / `open` / `click` / `dismiss` |
| `created_at` | `TIMESTAMPTZ` | DEFAULT NOW() | イベント発生日時 |
| `metadata` | `JSONB` | DEFAULT '{}' | 追加情報（デバイス情報、URL等） |

```sql
CREATE TABLE notification_events (
    id BIGSERIAL PRIMARY KEY,
    notification_id BIGINT NOT NULL,
    notification_type VARCHAR(20) NOT NULL DEFAULT 'scheduled',
    user_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
    event_type VARCHAR(20) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'
);

CREATE INDEX idx_ne_notification ON notification_events (notification_id);
CREATE INDEX idx_ne_event_type ON notification_events (event_type);
CREATE INDEX idx_ne_created_at ON notification_events (created_at);
CREATE INDEX idx_ne_user ON notification_events (user_id);
```

### F2-3. 新規テーブル: `notification_stats`（集計キャッシュ）

通知ごとの集計済みデータを保持し、ダッシュボードのパフォーマンスを確保する。

| カラム名 | 型 | 制約 | 説明 |
|---|---|---|---|
| `notification_id` | `BIGINT` | PRIMARY KEY | 対象通知ID |
| `notification_type` | `VARCHAR(20)` | NOT NULL | `scheduled` / `step` |
| `total_sent` | `INT` | DEFAULT 0 | 送信成功数 |
| `total_delivered` | `INT` | DEFAULT 0 | 配信数 |
| `total_opened` | `INT` | DEFAULT 0 | 開封数 |
| `total_clicked` | `INT` | DEFAULT 0 | クリック数 |
| `total_dismissed` | `INT` | DEFAULT 0 | 消去数 |
| `open_rate` | `DECIMAL(5,2)` | DEFAULT 0 | 開封率（%） |
| `ctr` | `DECIMAL(5,2)` | DEFAULT 0 | CTR（%） |
| `updated_at` | `TIMESTAMPTZ` | DEFAULT NOW() | 最終更新日時 |

```sql
CREATE TABLE notification_stats (
    notification_id BIGINT PRIMARY KEY,
    notification_type VARCHAR(20) NOT NULL DEFAULT 'scheduled',
    total_sent INT DEFAULT 0,
    total_delivered INT DEFAULT 0,
    total_opened INT DEFAULT 0,
    total_clicked INT DEFAULT 0,
    total_dismissed INT DEFAULT 0,
    open_rate DECIMAL(5,2) DEFAULT 0,
    ctr DECIMAL(5,2) DEFAULT 0,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### F2-4. 新規API

| # | メソッド | パス | 用途 |
|---|---|---|---|
| 1 | POST | `/api/track/open` | 通知開封イベント記録 |
| 2 | POST | `/api/track/click` | 通知クリックイベント記録 |
| 3 | GET | `/api/analytics/overview` | ダッシュボード用KPIサマリ |
| 4 | GET | `/api/analytics/notifications` | 通知別パフォーマンス一覧 |
| 5 | GET | `/api/analytics/trends` | 期間指定の推移データ（グラフ用） |
| 6 | GET | `/api/analytics/heatmap` | 時間帯別エンゲージメントデータ |

#### `POST /api/track/open`（認証不要・Service Workerから呼び出し）

```
リクエスト:
{
    "notification_id": 123,
    "notification_type": "scheduled",
    "user_id": 456  // optional
}

レスポンス:
{ "status": "ok" }
```

#### `POST /api/track/click`（認証不要・Service Workerから呼び出し）

```
リクエスト:
{
    "notification_id": 123,
    "notification_type": "scheduled",
    "user_id": 456,  // optional
    "url": "https://example.com/sale"
}

レスポンス:
{ "status": "ok" }
```

#### `GET /api/analytics/overview`（管理者認証必須）

```
レスポンス:
{
    "status": "ok",
    "data": {
        "total_users": 1234,
        "new_users_today": 12,
        "new_users_this_week": 56,
        "active_subscribers": 1180,
        "total_notifications_sent": 89,
        "avg_open_rate": 68.5,
        "avg_ctr": 12.3,
        "churn_rate_30d": 2.1,
        "trends": {
            "users_change_pct": 3.2,
            "new_users_change_pct": 12.0,
            "open_rate_change_pct": -2.1,
            "ctr_change_pct": 0.8
        }
    }
}
```

#### `GET /api/analytics/trends?period=30d&metric=users`（管理者認証必須）

```
レスポンス:
{
    "status": "ok",
    "data": {
        "period": "30d",
        "metric": "users",
        "data_points": [
            { "date": "2026-01-10", "value": 1100, "new": 15 },
            { "date": "2026-01-11", "value": 1115, "new": 12 },
            ...
        ]
    }
}
```

### F2-5. Service Worker改修

`sw.js` に以下のトラッキングコードを追加する。

```
[push イベント]
    │
    ├── 通知データからnotification_idを取得
    ├── POST /api/track/open を送信
    └── showNotification() で通知表示

[notificationclick イベント]
    │
    ├── 通知データからnotification_id, urlを取得
    ├── POST /api/track/click を送信
    └── clients.openWindow(url) でページ遷移
```

通知ペイロードに `notification_id` と `notification_type` を含める必要がある。

### F2-6. 通知一覧画面での表示

通知一覧の各通知カードに効果指標を表示する。

```
┌──────────────────────────────────────────────────────┐
│  📋 #5 | 2026/02/10 09:00                    ✅ 送信済み│
│  タイトル: 週末セールのお知らせ                           │
│  本文: 今週末は全品20%OFF...                            │
│  URL: https://example.com/sale                        │
│                                                      │
│  📊 パフォーマンス                                     │
│  ┌────────────┬────────────┬────────────┐            │
│  │ 送信: 1,234  │ 開封: 845   │ クリック: 152 │            │
│  │ 成功率: 98.2% │ 開封率: 68.5%│ CTR: 12.3%  │            │
│  └────────────┴────────────┴────────────┘            │
│                                                      │
│  [詳細を見る] [複製して再送] [削除]                       │
└──────────────────────────────────────────────────────┘
```

---

## F3. フィルタリング送信（セグメント配信）

### 目的
全ユーザーへの一斉送信ではなく、条件でフィルタリングした特定のユーザーグループに通知を送信する。

### F3-1. フィルタリング条件

| # | フィルター条件 | 説明 | 例 |
|---|---|---|---|
| 1 | 登録日 | ユーザーの登録日で絞り込み | 「過去7日以内に登録したユーザー」 |
| 2 | 登録期間 | 登録からの経過日数 | 「登録から30日以上経過したユーザー」 |
| 3 | デバイス・ブラウザ | User-Agentから判定 | 「iOSユーザーのみ」「Chromeユーザーのみ」 |
| 4 | エンゲージメント | 過去の通知への反応度 | 「過去30日間に1回以上クリックしたユーザー」 |
| 5 | ステップ配信進捗 | ステップシーケンスの進行状況 | 「ウェルカムシーケンス完了済みユーザー」 |
| 6 | タグ（手動セグメント） | 管理者が手動でつけたタグ | 「VIPタグ付きユーザー」 |
| 7 | 非アクティブ | 一定期間通知に反応がないユーザー | 「過去60日間開封なしのユーザー」 |

### F3-2. 新規テーブル: `user_segments`

| カラム名 | 型 | 制約 | 説明 |
|---|---|---|---|
| `id` | `BIGSERIAL` | PRIMARY KEY | 自動採番ID |
| `name` | `VARCHAR(100)` | NOT NULL, UNIQUE | セグメント名 |
| `description` | `TEXT` | | セグメントの説明 |
| `filter_conditions` | `JSONB` | NOT NULL | フィルター条件（JSON） |
| `is_dynamic` | `BOOLEAN` | DEFAULT TRUE | 動的セグメントかどうか |
| `created_at` | `TIMESTAMPTZ` | DEFAULT NOW() | 作成日時 |
| `updated_at` | `TIMESTAMPTZ` | DEFAULT NOW() | 更新日時 |

```sql
CREATE TABLE user_segments (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    filter_conditions JSONB NOT NULL,
    is_dynamic BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### filter_conditions のJSON構造

```json
{
    "operator": "AND",
    "conditions": [
        {
            "field": "registered_days_ago",
            "operator": "gte",
            "value": 7
        },
        {
            "field": "engagement_level",
            "operator": "eq",
            "value": "active"
        },
        {
            "field": "device_type",
            "operator": "in",
            "value": ["ios", "android"]
        }
    ]
}
```

### F3-3. 新規テーブル: `user_tags`

手動タグ管理用のテーブル。

| カラム名 | 型 | 制約 | 説明 |
|---|---|---|---|
| `id` | `BIGSERIAL` | PRIMARY KEY | 自動採番ID |
| `user_id` | `BIGINT` | NOT NULL, FK | ユーザーID |
| `tag` | `VARCHAR(50)` | NOT NULL | タグ名 |
| `created_at` | `TIMESTAMPTZ` | DEFAULT NOW() | 作成日時 |

```sql
CREATE TABLE user_tags (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    tag VARCHAR(50) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, tag)
);

CREATE INDEX idx_user_tags_tag ON user_tags (tag);
CREATE INDEX idx_user_tags_user ON user_tags (user_id);
```

### F3-4. usersテーブルへのカラム追加

フィルタリングに必要な情報を `users` テーブルに追加する。

| カラム名 | 型 | 説明 |
|---|---|---|
| `device_type` | `VARCHAR(20)` | `ios` / `android` / `desktop` / `other` |
| `browser` | `VARCHAR(50)` | `chrome` / `safari` / `firefox` / `edge` / `other` |
| `os` | `VARCHAR(50)` | `iOS 17` / `Android 14` / `Windows 11` 等 |
| `last_active_at` | `TIMESTAMPTZ` | 最後にイベントを発生させた日時 |
| `engagement_score` | `INT` | エンゲージメントスコア（0-100） |

```sql
ALTER TABLE users ADD COLUMN device_type VARCHAR(20);
ALTER TABLE users ADD COLUMN browser VARCHAR(50);
ALTER TABLE users ADD COLUMN os VARCHAR(50);
ALTER TABLE users ADD COLUMN last_active_at TIMESTAMPTZ;
ALTER TABLE users ADD COLUMN engagement_score INT DEFAULT 0;
```

### F3-5. 通知作成画面のUI改修

通知作成時にターゲットを選択できるようにする。

```
┌──────────────────────────────────────────────────────┐
│  通知作成                                             │
├──────────────────────────────────────────────────────┤
│                                                      │
│  タイトル                                             │
│  ┌────────────────────────────────────────────────┐  │
│  │ 週末セールのお知らせ                              │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  本文                                                │
│  ┌────────────────────────────────────────────────┐  │
│  │ 今週末は全品20%OFFでお買い得です！                 │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  タップ時のURL（省略可）                               │
│  ┌────────────────────────────────────────────────┐  │
│  │ https://example.com/sale                        │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  ─── 送信対象 ───────────────────────────────────    │
│                                                      │
│  ○ 全ユーザー（1,234人）                              │
│  ● セグメント指定                                     │
│                                                      │
│  セグメント選択:                                      │
│  ┌────────────────────────────────────────────────┐  │
│  │ ☑ アクティブユーザー（過去30日）        845人     │  │
│  │ ☐ 新規ユーザー（過去7日）              56人      │  │
│  │ ☐ iOSユーザー                        423人      │  │
│  │ ☐ 非アクティブ（60日以上）             189人      │  │
│  │ ☐ VIPタグ                             34人      │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  または、カスタムフィルター:                            │
│  ┌────────────────────────────────────────────────┐  │
│  │ 条件1: [登録日 ▼] [以降 ▼] [2026-01-01]         │  │
│  │ [+ 条件追加]                                    │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  📊 対象ユーザー数: 845人                              │
│                                                      │
│  送信日時                                             │
│  ┌────────────────────────────────────────────────┐  │
│  │ 2026-02-10T09:00                                │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  ┌──────────┐  ┌──────────┐                         │
│  │ 予約作成   │  │  戻る     │                         │
│  └──────────┘  └──────────┘                         │
│                                                      │
└──────────────────────────────────────────────────────┘
```

### F3-6. 新規API（フィルタリング関連）

| # | メソッド | パス | 用途 |
|---|---|---|---|
| 1 | GET | `/api/segments/list` | セグメント一覧取得 |
| 2 | POST | `/api/segments/create` | セグメント作成 |
| 3 | PUT | `/api/segments/update` | セグメント更新 |
| 4 | DELETE | `/api/segments/delete` | セグメント削除 |
| 5 | POST | `/api/segments/preview` | フィルター条件に該当するユーザー数を返す |
| 6 | POST | `/api/notifications/create-targeted` | セグメント指定での通知作成 |

### F3-7. notificationsテーブルへのカラム追加

| カラム名 | 型 | 説明 |
|---|---|---|
| `target_type` | `VARCHAR(20)` | `all` / `segment` / `custom_filter` |
| `target_segment_id` | `BIGINT` | 対象セグメントID（nullable） |
| `target_filter` | `JSONB` | カスタムフィルター条件（nullable） |
| `target_user_count` | `INT` | 送信対象ユーザー数 |

```sql
ALTER TABLE notifications ADD COLUMN target_type VARCHAR(20) DEFAULT 'all';
ALTER TABLE notifications ADD COLUMN target_segment_id BIGINT;
ALTER TABLE notifications ADD COLUMN target_filter JSONB;
ALTER TABLE notifications ADD COLUMN target_user_count INT;
```

---

## F4. 通知管理の強化

### 目的
通知の編集・削除・複製・検索を可能にし、日常の運用効率を向上させる。

### F4-1. 通知の編集

- 未送信（`sent = false`）の通知のみ編集可能
- 編集可能項目: タイトル、本文、URL、送信日時、送信対象
- 送信済みの通知は閲覧のみ

### F4-2. 通知の削除

- 未送信の通知: 確認ダイアログ後に物理削除
- 送信済みの通知: 論理削除（`deleted_at` カラム追加）

```sql
ALTER TABLE notifications ADD COLUMN deleted_at TIMESTAMPTZ;
```

### F4-3. 通知の複製

- 既存の通知をコピーして新規通知を作成
- タイトルに「（コピー）」を自動付与
- 送信日時は未設定にする

### F4-4. 通知の検索・フィルタリング

通知一覧画面に検索・フィルター機能を追加する。

| フィルター | 選択肢 |
|---|---|
| 状態 | すべて / 予約済み / 送信済み / 下書き |
| 期間 | 今日 / 今週 / 今月 / カスタム |
| 送信対象 | すべて / 全ユーザー / セグメント指定 |
| キーワード | タイトル・本文で部分一致検索 |
| ソート | 作成日（新→旧） / 作成日（旧→新） / 送信日 / 開封率 / CTR |

### F4-5. 通知の下書き保存

- `status` カラムを追加: `draft` / `scheduled` / `sent` / `cancelled`
- 下書きはいつでも編集可能
- 下書きから「予約」へのステータス変更

```sql
ALTER TABLE notifications ADD COLUMN status VARCHAR(20) DEFAULT 'scheduled';
-- 既存データの移行: sent = true → 'sent', sent = false → 'scheduled'
```

### F4-6. 新規API（通知管理関連）

| # | メソッド | パス | 用途 |
|---|---|---|---|
| 1 | PUT | `/api/notifications/update` | 通知編集 |
| 2 | DELETE | `/api/notifications/delete` | 通知削除 |
| 3 | POST | `/api/notifications/duplicate` | 通知複製 |
| 4 | GET | `/api/notifications/search` | 通知検索 |

---

## F5. ユーザー管理画面

### 目的
登録ユーザーの一覧・詳細表示およびセグメント管理を可能にする。

### F5-1. ユーザー一覧画面 `/admin/users`

```
┌──────────────────────────────────────────────────────┐
│  👤 ユーザー管理           全 1,234人     [CSVエクスポート]│
├──────────────────────────────────────────────────────┤
│                                                      │
│  🔍 [検索: ID / デバイス / タグ          ] [絞り込み ▼]  │
│                                                      │
│  ┌────┬────────┬────────┬──────┬───────┬──────┐      │
│  │ ID │ デバイス  │ 登録日   │ タグ   │ 開封率  │ 操作  │      │
│  ├────┼────────┼────────┼──────┼───────┼──────┤      │
│  │ 1  │ iOS/Safari│ 2/1   │ VIP  │ 85%   │ [詳細]│      │
│  │ 2  │ Android/C │ 2/2   │      │ 72%   │ [詳細]│      │
│  │ 3  │ Desktop/C │ 2/3   │ VIP  │ 45%   │ [詳細]│      │
│  │ .. │ ...      │ ...   │ ...  │ ...   │ ...  │      │
│  └────┴────────┴────────┴──────┴───────┴──────┘      │
│                                                      │
│  ◀ 1 2 3 ... 25 ▶  (50件/ページ)                      │
│                                                      │
└──────────────────────────────────────────────────────┘
```

### F5-2. ユーザー詳細画面 `/admin/users/:id`

```
┌──────────────────────────────────────────────────────┐
│  👤 ユーザー #123                           [← 戻る]   │
├──────────────────────────────────────────────────────┤
│                                                      │
│  基本情報                                             │
│  ├── デバイス: iOS / Safari 17.2                      │
│  ├── 登録日: 2026-01-15 14:30                         │
│  ├── 最終アクティブ: 2026-02-08 09:15                  │
│  └── エンゲージメントスコア: 85 / 100                    │
│                                                      │
│  タグ: [VIP ✕] [早期登録 ✕] [+ タグ追加]                │
│                                                      │
│  ─── 通知履歴 ─────────────────────────────────────   │
│                                                      │
│  📋 2/8 「週末セール」  → ✅開封 → ✅クリック           │
│  📋 2/5 「新商品入荷」  → ✅開封 → ❌未クリック          │
│  📋 2/1 「ウェルカム」  → ❌未開封                      │
│                                                      │
│  ─── ステップ配信進捗 ─────────────────────────────    │
│                                                      │
│  ウェルカムシーケンス: Step 3/5 (60%)                   │
│  ██████████████░░░░░░░░░░                             │
│  次回配信: 2026-02-09 12:00                            │
│                                                      │
│  ─── エンゲージメント推移 ─────────────────────────    │
│  [ミニグラフ: 過去30日の開封率推移]                       │
│                                                      │
└──────────────────────────────────────────────────────┘
```

### F5-3. 新規API（ユーザー管理関連）

| # | メソッド | パス | 用途 |
|---|---|---|---|
| 1 | GET | `/api/users/list` | ユーザー一覧（ページネーション付き） |
| 2 | GET | `/api/users/:id` | ユーザー詳細 |
| 3 | POST | `/api/users/:id/tags` | タグ追加 |
| 4 | DELETE | `/api/users/:id/tags/:tag` | タグ削除 |
| 5 | GET | `/api/users/:id/events` | ユーザーのイベント履歴 |
| 6 | GET | `/api/users/export` | ユーザーCSVエクスポート |

---

## F6. ステップ配信分析

### 目的
ステップシーケンスのパフォーマンスをファネル形式で可視化し、離脱ポイントを特定する。

### F6-1. シーケンス分析画面 `/admin/sequences/:id/analytics`

```
┌──────────────────────────────────────────────────────┐
│  📊 ウェルカムシーケンス 分析                           │
├──────────────────────────────────────────────────────┤
│                                                      │
│  概要                                                │
│  ├── 総登録ユーザー: 500人                             │
│  ├── 完了率: 45% (225人)                              │
│  ├── 平均完了期間: 12日                                │
│  └── 現在進行中: 180人                                │
│                                                      │
│  ─── ファネル分析 ─────────────────────────────────   │
│                                                      │
│  Step 1: ウェルカムメッセージ                           │
│  ████████████████████████████████████████ 500人 (100%)│
│  開封率: 82% | CTR: 34%                               │
│                                                      │
│  Step 2: 機能紹介                                     │
│  █████████████████████████████████  420人 (84%)       │
│  開封率: 75% | CTR: 28%         離脱: 80人 (16%)      │
│                                                      │
│  Step 3: 活用テクニック                                │
│  ██████████████████████████  350人 (70%)              │
│  開封率: 68% | CTR: 22%         離脱: 70人 (17%)      │
│                                                      │
│  Step 4: 特別オファー                                  │
│  ██████████████████████  290人 (58%)                  │
│  開封率: 71% | CTR: 38%         離脱: 60人 (17%)      │
│                                                      │
│  Step 5: フィードバック依頼                             │
│  ████████████████  225人 (45%)                        │
│  開封率: 65% | CTR: 15%         離脱: 65人 (22%)      │
│                                                      │
│  ─── ステップ間離脱率推移グラフ ───────────────────    │
│  [折れ線グラフ: 各ステップの継続率]                       │
│                                                      │
└──────────────────────────────────────────────────────┘
```

### F6-2. 新規API

| # | メソッド | パス | 用途 |
|---|---|---|---|
| 1 | GET | `/api/analytics/sequences/:id` | シーケンス別ファネルデータ |
| 2 | GET | `/api/analytics/sequences/overview` | 全シーケンスのサマリ |

---

## F7. A/Bテスト機能（P2）

### 目的
通知文面やタイミングの最適化のため、複数バリエーションを比較テストする。

### F7-1. 仕組み

1. 管理者がA/B 2パターンの通知を作成
2. 対象ユーザーをランダムに均等分割
3. 各パターンを別々のグループに送信
4. 開封率・CTRを比較し、勝者パターンを残りのユーザーに送信（オプション）

### F7-2. 新規テーブル: `ab_tests`

| カラム名 | 型 | 制約 | 説明 |
|---|---|---|---|
| `id` | `BIGSERIAL` | PRIMARY KEY | テストID |
| `name` | `VARCHAR(200)` | NOT NULL | テスト名 |
| `status` | `VARCHAR(20)` | DEFAULT 'draft' | `draft` / `running` / `completed` |
| `variant_a_notification_id` | `BIGINT` | FK | パターンA通知ID |
| `variant_b_notification_id` | `BIGINT` | FK | パターンB通知ID |
| `winner` | `VARCHAR(1)` | | 勝者（`A` / `B` / null） |
| `test_size_pct` | `INT` | DEFAULT 50 | テストに使用するユーザーの割合 |
| `winning_metric` | `VARCHAR(20)` | DEFAULT 'ctr' | 判定指標（`open_rate` / `ctr`） |
| `created_at` | `TIMESTAMPTZ` | DEFAULT NOW() | |
| `completed_at` | `TIMESTAMPTZ` | | |

---

## F8. エクスポート機能（P2）

### 目的
分析データをCSV/JSON形式でダウンロードし、外部ツールでの分析を可能にする。

### F8-1. エクスポート対象

| # | データ | フォーマット | 含まれるフィールド |
|---|---|---|---|
| 1 | ユーザー一覧 | CSV | ID, デバイス, ブラウザ, 登録日, タグ, エンゲージメントスコア |
| 2 | 通知パフォーマンス | CSV | 通知ID, タイトル, 送信日, 送信数, 開封数, クリック数, 開封率, CTR |
| 3 | イベントログ | CSV/JSON | タイムスタンプ, イベントタイプ, 通知ID, ユーザーID |
| 4 | ステップ配信レポート | CSV | シーケンス名, ステップ, 送信数, 開封率, CTR, 離脱率 |

### F8-2. 新規API

| # | メソッド | パス | 用途 |
|---|---|---|---|
| 1 | GET | `/api/export/users` | ユーザーCSVエクスポート |
| 2 | GET | `/api/export/notifications` | 通知パフォーマンスCSVエクスポート |
| 3 | GET | `/api/export/events` | イベントログエクスポート |

---

## F9. 通知テンプレート（P2）

### 目的
よく使う通知文面をテンプレートとして保存・再利用する。

### F9-1. 新規テーブル: `notification_templates`

| カラム名 | 型 | 制約 | 説明 |
|---|---|---|---|
| `id` | `BIGSERIAL` | PRIMARY KEY | |
| `name` | `VARCHAR(100)` | NOT NULL | テンプレート名 |
| `title` | `VARCHAR(100)` | NOT NULL | 通知タイトル |
| `body` | `TEXT` | NOT NULL | 通知本文 |
| `url` | `TEXT` | | デフォルトURL |
| `category` | `VARCHAR(50)` | | カテゴリ（セール、お知らせ等） |
| `created_at` | `TIMESTAMPTZ` | DEFAULT NOW() | |
| `updated_at` | `TIMESTAMPTZ` | DEFAULT NOW() | |

### F9-2. 変数埋め込み

テンプレート本文内で変数を使用可能にする。

| 変数 | 説明 | 例 |
|---|---|---|
| `{{user_id}}` | ユーザーID | `123` |
| `{{registered_days}}` | 登録からの日数 | `30` |
| `{{date}}` | 当日の日付 | `2026年2月8日` |

---

## 管理画面ナビゲーション構成

### 改修後のメニュー構造

```
管理画面
├── 📊 ダッシュボード        /admin
│   ├── KPIサマリカード
│   ├── グラフ表示
│   └── アクティビティログ
│
├── ✉️ 通知管理             /admin/notifications
│   ├── 通知一覧（検索・フィルター付き）
│   ├── 通知作成（フィルタリング送信対応）  /admin/notifications/create
│   └── 通知詳細（パフォーマンス表示）      /admin/notifications/:id
│
├── 🔄 ステップ配信          /admin/sequences
│   ├── シーケンス一覧
│   ├── シーケンス作成        /admin/sequences/create
│   └── シーケンス分析        /admin/sequences/:id/analytics
│
├── 👤 ユーザー管理          /admin/users
│   ├── ユーザー一覧
│   └── ユーザー詳細          /admin/users/:id
│
├── 🏷️ セグメント管理        /admin/segments
│   ├── セグメント一覧
│   └── セグメント作成        /admin/segments/create
│
├── 🧪 A/Bテスト            /admin/ab-tests     (P2)
│   ├── テスト一覧
│   └── テスト作成
│
├── 📄 テンプレート          /admin/templates    (P2)
│   ├── テンプレート一覧
│   └── テンプレート作成
│
└── ⚙️ 設定                /admin/settings     (P2)
    ├── 通知デフォルト設定
    └── エクスポート
```

---

## 新規DB設計まとめ

### 新規テーブル一覧

| # | テーブル | 用途 | 優先度 |
|---|---|---|---|
| 1 | `notification_events` | 通知イベントログ（開封・クリック等） | P0 |
| 2 | `notification_stats` | 通知別の集計キャッシュ | P0 |
| 3 | `user_segments` | セグメント定義 | P0 |
| 4 | `user_tags` | ユーザータグ | P0 |
| 5 | `activity_logs` | 管理画面アクティビティログ | P1 |
| 6 | `ab_tests` | A/Bテスト管理 | P2 |
| 7 | `notification_templates` | 通知テンプレート | P2 |

### 既存テーブル変更

| テーブル | 追加カラム | 優先度 |
|---|---|---|
| `users` | `device_type`, `browser`, `os`, `last_active_at`, `engagement_score` | P0 |
| `notifications` | `target_type`, `target_segment_id`, `target_filter`, `target_user_count`, `status`, `deleted_at` | P0 |

---

## 新規API設計まとめ

### 全API一覧

| # | メソッド | パス | 認証 | 優先度 | 用途 |
|---|---|---|---|---|---|
| 1 | POST | `/api/track/open` | なし | P0 | 通知開封トラッキング |
| 2 | POST | `/api/track/click` | なし | P0 | 通知クリックトラッキング |
| 3 | GET | `/api/analytics/overview` | 管理者 | P0 | ダッシュボードKPIサマリ |
| 4 | GET | `/api/analytics/notifications` | 管理者 | P0 | 通知別パフォーマンス |
| 5 | GET | `/api/analytics/trends` | 管理者 | P0 | 推移データ（グラフ用） |
| 6 | GET | `/api/analytics/heatmap` | 管理者 | P1 | 時間帯別エンゲージメント |
| 7 | GET | `/api/segments/list` | 管理者 | P0 | セグメント一覧 |
| 8 | POST | `/api/segments/create` | 管理者 | P0 | セグメント作成 |
| 9 | PUT | `/api/segments/update` | 管理者 | P0 | セグメント更新 |
| 10 | DELETE | `/api/segments/delete` | 管理者 | P0 | セグメント削除 |
| 11 | POST | `/api/segments/preview` | 管理者 | P0 | フィルターマッチ数プレビュー |
| 12 | POST | `/api/notifications/create-targeted` | 管理者 | P0 | ターゲット送信通知作成 |
| 13 | PUT | `/api/notifications/update` | 管理者 | P1 | 通知編集 |
| 14 | DELETE | `/api/notifications/delete` | 管理者 | P1 | 通知削除 |
| 15 | POST | `/api/notifications/duplicate` | 管理者 | P1 | 通知複製 |
| 16 | GET | `/api/notifications/search` | 管理者 | P1 | 通知検索 |
| 17 | GET | `/api/users/list` | 管理者 | P1 | ユーザー一覧 |
| 18 | GET | `/api/users/:id` | 管理者 | P1 | ユーザー詳細 |
| 19 | POST | `/api/users/:id/tags` | 管理者 | P1 | タグ追加 |
| 20 | DELETE | `/api/users/:id/tags/:tag` | 管理者 | P1 | タグ削除 |
| 21 | GET | `/api/users/:id/events` | 管理者 | P1 | ユーザーイベント履歴 |
| 22 | GET | `/api/analytics/sequences/:id` | 管理者 | P1 | シーケンスファネル分析 |
| 23 | GET | `/api/analytics/sequences/overview` | 管理者 | P1 | シーケンスサマリ |
| 24 | GET | `/api/export/users` | 管理者 | P2 | ユーザーCSVエクスポート |
| 25 | GET | `/api/export/notifications` | 管理者 | P2 | 通知CSVエクスポート |
| 26 | GET | `/api/export/events` | 管理者 | P2 | イベントCSVエクスポート |

---

## 技術的考慮事項

### フロントエンド

| 項目 | 方針 |
|---|---|
| グラフライブラリ | **Chart.js v4**（CDN読み込み、軽量・バニラJS対応） |
| UIフレームワーク | 引き続きバニラHTML/CSS/JS（一貫性のため） |
| ページ構成 | 各画面を独立HTMLファイルとして作成（SPAではない） |
| レスポンシブ | モバイルからも操作可能（ただし管理画面はPC推奨） |
| 日付操作 | ネイティブ `Intl.DateTimeFormat` を使用 |

### バックエンド

| 項目 | 方針 |
|---|---|
| トラッキングAPI | レート制限を実装（同一ユーザーの重複イベント防止） |
| 集計キャッシュ | `notification_stats` は定期更新（cron 5分間隔）またはイベント発生時に更新 |
| ページネーション | カーソルベース（大量データ対応） |
| エクスポート | ストリーミングレスポンス（大量データのメモリ消費抑制） |

### パフォーマンス

| 項目 | 対策 |
|---|---|
| ダッシュボード読み込み | 集計テーブル使用、APIレスポンスキャッシュ（60秒） |
| グラフデータ | サーバーサイドで集計済みデータを返す |
| ユーザー一覧 | ページネーション + インデックス最適化 |
| イベントテーブル肥大化 | 90日以上前のデータはアーカイブ / 削除（cron） |

### セキュリティ

| 項目 | 対策 |
|---|---|
| トラッキングAPI | 認証不要だが、IPベースのレート制限を実装 |
| notification_id の推測防止 | UUIDの採用を検討（現在のBIGSERIALから変更） |
| 管理画面API | 全て管理者認証必須（既存と同様） |

---

## 開発フェーズ案

### Phase 1（P0: 必須機能）— 推定 5-7日

| # | タスク | 工数目安 |
|---|---|---|
| 1 | DB: `notification_events`, `notification_stats` テーブル作成 | 0.5日 |
| 2 | DB: `user_segments`, `user_tags` テーブル作成 | 0.5日 |
| 3 | DB: `users`, `notifications` テーブルカラム追加 | 0.5日 |
| 4 | API: トラッキングAPI (`/api/track/open`, `/api/track/click`) | 0.5日 |
| 5 | SW: Service Worker改修（トラッキングコード追加） | 0.5日 |
| 6 | API: アナリティクスAPI (`/api/analytics/*`) | 1日 |
| 7 | API: セグメントAPI (`/api/segments/*`) | 1日 |
| 8 | 画面: ダッシュボード強化（KPIカード + Chart.js グラフ） | 1日 |
| 9 | 画面: 通知作成画面のフィルタリング送信対応 | 0.5日 |
| 10 | 画面: 通知一覧のパフォーマンス表示 | 0.5日 |

### Phase 2（P1: 重要機能）— 推定 4-5日

| # | タスク | 工数目安 |
|---|---|---|
| 1 | API: 通知管理API（編集・削除・複製・検索） | 1日 |
| 2 | 画面: 通知管理画面の強化 | 1日 |
| 3 | API: ユーザー管理API | 1日 |
| 4 | 画面: ユーザー一覧・詳細画面 | 1日 |
| 5 | API + 画面: ステップ配信ファネル分析 | 1日 |

### Phase 3（P2: あると良い機能）— 推定 3-4日

| # | タスク | 工数目安 |
|---|---|---|
| 1 | A/Bテスト機能 | 1.5日 |
| 2 | エクスポート機能 | 0.5日 |
| 3 | 通知テンプレート機能 | 1日 |

---

## 備考

- 本ドキュメントは要件定義段階であり、開発着手前のレビュー・調整が前提
- 優先度は運用上のインパクトと開発コストを考慮して設定
- 各機能の詳細仕様はPhaseごとに別途設計書を作成する想定
- 既存のバニラJS + Vercel Serverless構成を維持し、大きな技術変更は行わない
