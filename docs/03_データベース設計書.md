# 03. データベース設計書（Supabase / PostgreSQL）

## 概要

MVPでは最小限の2テーブル構成とする。
Supabase（PostgreSQL）を使用し、Node.jsからは `@supabase/supabase-js` で操作する。

---

## テーブル一覧

| テーブル名 | 用途 | レコード規模 |
|---|---|---|
| `users` | FCMトークン管理 | 数千件想定 |
| `notifications` | 通知予約管理 | 数百件想定 |

---

## 1. users テーブル

### 目的
プッシュ通知送信先のFCMトークンを保存する。
ユーザーの個人情報は一切保持しない。

### スキーマ

| カラム名 | 型 | 制約 | 説明 |
|---|---|---|---|
| `id` | `BIGSERIAL` | PRIMARY KEY | 自動採番ID |
| `fcm_token` | `TEXT` | NOT NULL, UNIQUE | FCMデバイストークン |
| `created_at` | `TIMESTAMPTZ` | DEFAULT NOW() | 登録日時 |

### SQL

```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    fcm_token TEXT NOT NULL UNIQUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_users_token ON users (fcm_token);
```

### 備考
- FCMトークンは端末ごとに一意
- トークンが重複した場合は `onConflict: 'fcm_token'` で無視（再登録対応）
- トークンが無効化された場合、FCMからエラーが返るので、その際に削除する（Phase2で検討）

---

## 2. notifications テーブル

### 目的
管理者が作成した通知の内容・送信日時を管理する。

### スキーマ

| カラム名 | 型 | 制約 | 説明 |
|---|---|---|---|
| `id` | `BIGSERIAL` | PRIMARY KEY | 自動採番ID |
| `title` | `VARCHAR(100)` | NOT NULL | 通知タイトル（1行） |
| `body` | `TEXT` | NOT NULL | 通知本文（2〜3行） |
| `url` | `TEXT` | DEFAULT '' | タップ時遷移先URL（省略可） |
| `send_at` | `TIMESTAMPTZ` | NOT NULL | 送信予定日時 |
| `sent` | `BOOLEAN` | DEFAULT FALSE | 送信済みフラグ |
| `created_at` | `TIMESTAMPTZ` | DEFAULT NOW() | 作成日時 |

### SQL

```sql
CREATE TABLE notifications (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(100) NOT NULL,
    body TEXT NOT NULL,
    url TEXT DEFAULT '',
    send_at TIMESTAMPTZ NOT NULL,
    sent BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_notifications_pending ON notifications (send_at) WHERE sent = FALSE;
```

---

## ER図

```
┌──────────────────┐          ┌──────────────────────┐
│      users       │          │    notifications     │
├──────────────────┤          ├──────────────────────┤
│ id (PK)          │          │ id (PK)              │
│ fcm_token (UQ)   │          │ title                │
│ created_at       │          │ body                 │
└──────────────────┘          │ url                  │
                              │ send_at              │
    ※ リレーションなし          │ sent                 │
    （一斉送信のため）          │ created_at           │
                              └──────────────────────┘
```

---

## RLS（Row Level Security）設定

```sql
-- usersテーブル: INSERT のみ許可（anonキー用）
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow anonymous insert" ON users
    FOR INSERT
    TO anon
    WITH CHECK (true);

-- notificationsテーブル: サーバーサイドのみ操作（service_role key使用）
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
```

---

## Node.js (supabase-js) 操作例

### Supabaseクライアント初期化（`lib/supabase.js`）

```javascript
import { createClient } from '@supabase/supabase-js';

// サーバーサイド用（service_role key → RLSバイパス）
export const supabaseAdmin = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_ROLE_KEY
);
```

### トークン登録（INSERT / UPSERT）

```javascript
const { data, error } = await supabaseAdmin
    .from('users')
    .upsert(
        { fcm_token: token },
        { onConflict: 'fcm_token' }
    );
```

### 未送信通知取得（SELECT）

```javascript
const { data, error } = await supabaseAdmin
    .from('notifications')
    .select('*')
    .eq('sent', false)
    .lte('send_at', new Date().toISOString())
    .order('send_at', { ascending: true });
```

### 全ユーザートークン取得

```javascript
const { data, error } = await supabaseAdmin
    .from('users')
    .select('fcm_token');

const tokens = data.map(u => u.fcm_token);
```

### 送信済み更新（UPDATE）

```javascript
const { error } = await supabaseAdmin
    .from('notifications')
    .update({ sent: true })
    .eq('id', notificationId);
```

---

## データライフサイクル

```
[ユーザーがPWAを開く]
        │
        ▼
[通知許可 → FCMトークン取得]
        │
        ▼
[POST /api/register-token]
        │
        ▼
[Serverless Function → Supabase users INSERT]
        │
        ▼
[管理者が管理画面から通知作成]
        │
        ▼
[POST /api/notifications/create]
        │
        ▼
[Serverless Function → Supabase notifications INSERT]
        │
        ▼
[Vercel Cron 実行（5分間隔）]
        │
        ├── notifications から未送信取得
        ├── users から全トークン取得
        ├── firebase-admin で FCM 送信
        └── notifications.sent = true に更新
```
