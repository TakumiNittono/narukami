# 02. 技術スタック・環境構築手順

## 技術スタック

### フロントエンド（ユーザー向けPWA）
| 項目 | 技術 |
|---|---|
| HTML/CSS/JS | バニラ（フレームワーク不使用） |
| PWA | manifest.json + Service Worker |
| Push通知 | Firebase Cloud Messaging (FCM) |
| FCM SDK | Firebase JavaScript SDK v9+ (modular / CDN) |

### バックエンド
| 項目 | 技術 |
|---|---|
| 言語 | **Node.js (JavaScript)** |
| ホスティング | **Vercel** (Serverless Functions) |
| DB | Supabase（PostgreSQL） |
| 通知 | FCM HTTP v1 API（firebase-admin SDK） |
| 定期実行 | **Vercel Cron Jobs** |

### 外部サービス
| サービス | 用途 | 費用 |
|---|---|---|
| Vercel | ホスティング + Serverless + Cron | **無料（Hobbyプラン）** |
| Firebase | FCM（Push通知） | 無料 |
| Supabase | データベース（PostgreSQL） | 無料枠あり |
| GitHub | ソースコード管理 + Vercel連携 | 無料 |

### Xサーバーから Vercel に変更した利点
| 項目 | Xサーバー | Vercel |
|---|---|---|
| デプロイ | FTP手動アップ | `git push` で自動 |
| HTTPS | 設定が必要 | 自動設定 |
| 言語 | PHP | Node.js |
| cron | サーバーcron設定 | vercel.json に記述するだけ |
| スケール | 固定サーバー | サーバーレス（自動スケール） |
| 費用 | 月額あり | 無料枠で十分 |
| 環境変数 | ファイル配置 | Vercelダッシュボードで安全に管理 |

---

## 環境構築手順

### STEP 0: 前提ツールのインストール

```bash
# Node.js（18以上推奨）
node -v   # 確認

# npm（Node.jsに同梱）
npm -v    # 確認

# Vercel CLI
npm install -g vercel

# Git
git --version  # 確認
```

---

### STEP 1: Firebaseプロジェクト作成

1. [Firebase Console](https://console.firebase.google.com/) にアクセス
2. 「プロジェクトを追加」をクリック
3. プロジェクト名: `narukami-mvp`（任意）
4. Google Analyticsは **無効** でOK
5. プロジェクト作成完了

#### 1-1. Webアプリ登録
1. プロジェクト設定 → 「アプリを追加」→ Webアイコン（</>）
2. アプリ名: `narukami-pwa`
3. Firebase Hosting は **チェック不要**
4. 表示される `firebaseConfig` をメモ

```javascript
// メモする内容（例）
const firebaseConfig = {
  apiKey: "AIza...",
  authDomain: "narukami-mvp.firebaseapp.com",
  projectId: "narukami-mvp",
  storageBucket: "narukami-mvp.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abc..."
};
```

#### 1-2. Cloud Messaging設定
1. プロジェクト設定 → Cloud Messaging タブ
2. 「Web Push証明書」の「Generate key pair」をクリック
3. 表示される **VAPID Key** をメモ

#### 1-3. サービスアカウントキー取得
1. プロジェクト設定 → サービスアカウント タブ
2. 「新しい秘密鍵の生成」をクリック
3. JSONファイルをダウンロード
4. → **Vercelの環境変数に設定する**（ファイルとしてはアップしない）

---

### STEP 2: Supabaseプロジェクト作成

1. [Supabase](https://supabase.com/) にアクセス
2. 「Start your project」をクリック
3. 組織を作成（初回のみ）
4. プロジェクト作成:
   - Name: `narukami-mvp`
   - Database Password: **強固なパスワードを設定（メモ必須）**
   - Region: `Northeast Asia (Tokyo)` 推奨
5. プロジェクト作成完了を待つ

#### 2-1. APIキー取得
1. Settings → API
2. 以下をメモ:
   - **Project URL**: `https://xxxxx.supabase.co`
   - **anon (public) key**: `eyJ...`（フロントエンド用）
   - **service_role key**: `eyJ...`（サーバーサイド用 ※秘密）

#### 2-2. テーブル作成
SQL Editorで以下を実行（詳細は `03_データベース設計書.md` 参照）:

```sql
-- usersテーブル
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    fcm_token TEXT NOT NULL UNIQUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- notificationsテーブル
CREATE TABLE notifications (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(100) NOT NULL,
    body TEXT NOT NULL,
    url TEXT DEFAULT '',
    send_at TIMESTAMPTZ NOT NULL,
    sent BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_notifications_pending ON notifications (send_at) WHERE sent = FALSE;
CREATE INDEX idx_users_token ON users (fcm_token);
```

#### 2-3. RLS（Row Level Security）設定
```sql
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow anonymous insert" ON users
    FOR INSERT
    TO anon
    WITH CHECK (true);

ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
-- notifications はサーバーサイド（service_role key）のみ操作
```

---

### STEP 3: プロジェクト初期化

```bash
# プロジェクトフォルダに移動
cd MVPnarukami

# package.json 初期化
npm init -y

# 依存パッケージインストール
npm install firebase-admin @supabase/supabase-js

# GitHubリポジトリ作成 & push
git init
git add .
git commit -m "初期セットアップ"
git remote add origin https://github.com/ユーザー名/narukami-mvp.git
git push -u origin main
```

---

### STEP 4: Vercelセットアップ

#### 4-1. Vercelアカウント作成
1. [Vercel](https://vercel.com/) にGitHubアカウントでサインアップ
2. GitHubリポジトリをインポート

#### 4-2. 環境変数設定（Vercelダッシュボード）
Vercelプロジェクト → Settings → Environment Variables に以下を設定:

| 変数名 | 値 | 説明 |
|---|---|---|
| `FIREBASE_PROJECT_ID` | `narukami-mvp` | Firebaseプロジェクト名 |
| `FIREBASE_CLIENT_EMAIL` | `firebase-adminsdk-xxx@...` | サービスアカウントのemail |
| `FIREBASE_PRIVATE_KEY` | `-----BEGIN PRIVATE KEY-----\n...` | サービスアカウントの秘密鍵 |
| `SUPABASE_URL` | `https://xxxxx.supabase.co` | SupabaseプロジェクトURL |
| `SUPABASE_SERVICE_ROLE_KEY` | `eyJ...` | Supabase service_role key |
| `SUPABASE_ANON_KEY` | `eyJ...` | Supabase anon key |
| `ADMIN_PASSWORD` | `任意の強固なパスワード` | 管理画面認証用 |
| `CRON_SECRET` | `任意のランダム文字列` | cron認証用シークレット |

> **重要**: `FIREBASE_PRIVATE_KEY` は改行を `\n` に置換して1行で設定する

#### 4-3. vercel.json 作成

```json
{
  "crons": [
    {
      "path": "/api/cron/send-scheduled",
      "schedule": "*/5 * * * *"
    }
  ],
  "rewrites": [
    { "source": "/admin", "destination": "/admin/index.html" },
    { "source": "/admin/create", "destination": "/admin/create.html" },
    { "source": "/thanks", "destination": "/pages/thanks.html" },
    { "source": "/", "destination": "/pages/index.html" }
  ],
  "headers": [
    {
      "source": "/api/(.*)",
      "headers": [
        { "key": "Access-Control-Allow-Origin", "value": "*" },
        { "key": "Access-Control-Allow-Methods", "value": "GET, POST, OPTIONS" },
        { "key": "Access-Control-Allow-Headers", "value": "Content-Type, Authorization" }
      ]
    }
  ]
}
```

#### 4-4. ローカル開発

```bash
# .env.local に環境変数を設定（ローカル用）
cp .env.example .env.local
# → 各値を記入

# ローカル開発サーバー起動
vercel dev
# → http://localhost:3000 で動作確認
```

---

### STEP 5: デプロイ

```bash
# 初回デプロイ（Vercel CLIから）
vercel

# 以降は git push で自動デプロイ
git add .
git commit -m "機能追加"
git push
# → Vercelが自動でビルド & デプロイ
```

---

## 環境変数一覧

| 設定項目 | ローカル | 本番（Vercel） | 公開可否 |
|---|---|---|---|
| Firebase Config | `js/app.js` に直書き | `js/app.js` に直書き | 公開OK |
| VAPID Key | `js/app.js` に直書き | `js/app.js` に直書き | 公開OK |
| Firebase Admin 認証情報 | `.env.local` | Vercel環境変数 | **秘密** |
| Supabase URL | `.env.local` | Vercel環境変数 | 公開OK（API keyと別） |
| Supabase Service Role Key | `.env.local` | Vercel環境変数 | **秘密** |
| 管理画面パスワード | `.env.local` | Vercel環境変数 | **秘密** |
| CRON_SECRET | `.env.local` | Vercel環境変数 | **秘密** |

---

## チェックリスト

- [ ] Node.js 18以上インストール済み
- [ ] Vercel CLIインストール済み
- [ ] Firebaseプロジェクト作成済み
- [ ] FirebaseConfig取得済み
- [ ] VAPID Key取得済み
- [ ] サービスアカウント情報取得済み
- [ ] Supabaseプロジェクト作成済み
- [ ] Supabase APIキー取得済み
- [ ] Supabaseテーブル作成済み
- [ ] GitHubリポジトリ作成済み
- [ ] Vercelプロジェクト作成・GitHubと連携済み
- [ ] Vercel環境変数設定済み
- [ ] `vercel dev` でローカル起動確認済み
